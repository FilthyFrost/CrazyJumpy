import{r as q,g as J}from"./phaser-DFK5Ua9d.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const n of a.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&s(n)}).observe(document,{childList:!0,subtree:!0});function e(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=e(i);fetch(i.href,a)}})();var Q=q();const m=J(Q);class tt extends m.Scene{buttons=[];titleText;constructor(){super({key:"MainMenuScene"})}preload(){this.textures.exists("backpack_icon")||this.load.image("backpack_icon","assets/ui/Backpack.png")}create(){const{width:t,height:e}=this.scale;this.createBackground(t,e),this.createTitle(t),this.createMenuButtons(t,e),this.createVersionText(t,e),this.createDecorations(t)}createBackground(t,e){const s=this.add.graphics();s.fillStyle(1710638,1),s.fillRect(0,0,t,e),s.lineStyle(1,2434373,.3);const i=32;for(let a=0;a<t;a+=i)s.lineBetween(a,0,a,e);for(let a=0;a<e;a+=i)s.lineBetween(0,a,t,a);this.createArchDecoration(t,e)}createArchDecoration(t,e){const s=this.add.graphics();s.fillStyle(986906,.8);const i=80,a=120,n=100,r=t%n/2;for(let o=r;o<t;o+=n)s.fillRect(o-i/2,e-a,i,a),s.fillCircle(o,e-a,i/2)}createTitle(t){const e={fontFamily:'"Press Start 2P", "Courier New", monospace',fontSize:"28px",color:"#7cba5f",stroke:"#2d4a1c",strokeThickness:6,shadow:{offsetX:3,offsetY:3,color:"#1a2e12",blur:0,fill:!0}};this.titleText=this.add.text(t/2,120,"CRAZY",e).setOrigin(.5);const s={fontFamily:'"Press Start 2P", "Courier New", monospace',fontSize:"36px",color:"#8fd464",stroke:"#2d4a1c",strokeThickness:8,shadow:{offsetX:4,offsetY:4,color:"#1a2e12",blur:0,fill:!0}};this.add.text(t/2,170,"JUMPY",s).setOrigin(.5),this.tweens.add({targets:this.titleText,scaleX:1.05,scaleY:1.05,duration:1500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}createMenuButtons(t,e){const s=[{text:"ËøõÂÖ•Ê∏∏Êàè",icon:"‚ñ∂",action:()=>this.startGame()},{text:"‰ªì  Â∫ì",icon:"üì¶",action:()=>this.openWarehouse()},{text:"ÂïÜ  Â∫ó",icon:"üõí",action:()=>this.openShop()},{text:"ËÆæ  ÁΩÆ",icon:"‚öô",action:()=>this.openSettings()},{text:"ÂÖ≥  ‰∫é",icon:"‚ùì",action:()=>this.openAbout()}],i=280,a=95,n=280,r=70;s.forEach((o,l)=>{const c=i+l*a,f=this.createWoodenButton(t/2,c,n,r,o.text,o.icon,o.action);this.buttons.push(f),f.setX(-200),f.setAlpha(0),this.tweens.add({targets:f,x:t/2,alpha:1,duration:400,delay:l*100,ease:"Back.easeOut"})})}createWoodenButton(t,e,s,i,a,n,r){const o=this.add.container(t,e),l=this.add.graphics();l.fillStyle(1707781,.6),l.fillRoundedRect(-s/2+4,-i/2+6,s,i,8),o.add(l);const c=this.add.graphics();c.fillStyle(9132587,1),c.fillRoundedRect(-s/2,-i/2,s,i,8),c.fillStyle(10910802,1),c.fillRoundedRect(-s/2+4,-i/2+4,s-8,i/3,6),c.fillStyle(7029795,1),c.fillRoundedRect(-s/2+4,i/6,s-8,i/3,6),c.lineStyle(3,4862489,1),c.strokeRoundedRect(-s/2,-i/2,s,i,8),c.lineStyle(2,12883306,.5),c.strokeRoundedRect(-s/2+3,-i/2+3,s-6,i-6,6),o.add(c),this.addNail(o,-s/2+15,0),this.addNail(o,s/2-15,0);const f=this.add.text(-s/2+45,0,n,{fontSize:"24px",color:"#3d2817"}).setOrigin(.5);o.add(f);const p=this.add.text(15,0,a,{fontFamily:'"Press Start 2P", "Microsoft YaHei", sans-serif',fontSize:"16px",color:"#3d2817",stroke:"#c4956a",strokeThickness:1}).setOrigin(.5);o.add(p);const d=this.add.rectangle(0,0,s,i,16777215,0);return d.setInteractive({useHandCursor:!0}),o.add(d),d.on("pointerover",()=>{this.tweens.add({targets:o,scaleX:1.05,scaleY:1.05,duration:100,ease:"Quad.easeOut"}),p.setColor("#1a0f05")}),d.on("pointerout",()=>{this.tweens.add({targets:o,scaleX:1,scaleY:1,duration:100,ease:"Quad.easeOut"}),p.setColor("#3d2817")}),d.on("pointerdown",()=>{r(),this.tweens.add({targets:o,scaleX:.95,scaleY:.95,duration:50,yoyo:!0,ease:"Quad.easeInOut"})}),o}addNail(t,e,s){const i=this.add.graphics();i.fillStyle(2759178,.5),i.fillCircle(e+2,s+2,6),i.fillStyle(6045747,1),i.fillCircle(e,s,6),i.fillStyle(9139029,1),i.fillCircle(e-2,s-2,3),t.add(i)}createDecorations(t){this.createFlameEffect(t*.15,200),this.createFlameEffect(t*.85,200)}createFlameEffect(t,e){const s=this.add.container(t,e),i=this.add.graphics();i.fillStyle(4864040,1),i.fillRect(-15,20,30,15),i.fillStyle(4007959,1),i.fillTriangle(-20,35,20,35,0,20),s.add(i);const a=[65416,4521898,8978380,11206621];for(let n=0;n<8;n++){const r=this.add.graphics(),o=a[n%a.length];r.fillStyle(o,.7-n*.05);const l=20-n*2,c=40-n*3;r.fillEllipse(0,-n*5,l,c),s.add(r),this.tweens.add({targets:r,x:m.Math.Between(-5,5),scaleX:m.Math.FloatBetween(.8,1.2),scaleY:m.Math.FloatBetween(.9,1.1),alpha:m.Math.FloatBetween(.4,.8),duration:200+n*50,yoyo:!0,repeat:-1,ease:"Sine.easeInOut",delay:n*30})}this.tweens.add({targets:s,x:t+m.Math.Between(-3,3),duration:500,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"})}createVersionText(t,e){this.add.text(t-20,e-20,"v0.1.0",{fontFamily:'"Press Start 2P", monospace',fontSize:"12px",color:"#4a4a6a"}).setOrigin(1,1)}startGame(){this.cameras.main.fadeOut(300,0,0,0),this.cameras.main.once("camerafadeoutcomplete",()=>{this.scene.start("GameScene")})}openWarehouse(){this.showComingSoon("‰ªìÂ∫ìÂäüËÉΩÂºÄÂèë‰∏≠...")}openShop(){this.showComingSoon("ÂïÜÂ∫óÂäüËÉΩÂºÄÂèë‰∏≠...")}openSettings(){this.showComingSoon("ËÆæÁΩÆÂäüËÉΩÂºÄÂèë‰∏≠...")}openAbout(){this.showAboutDialog()}showComingSoon(t){const{width:e,height:s}=this.scale,i=this.add.rectangle(e/2,s/2,e,s,0,.7).setInteractive(),a=this.add.graphics();a.fillStyle(2763338,1),a.fillRoundedRect(e/2-150,s/2-60,300,120,12),a.lineStyle(3,6974090,1),a.strokeRoundedRect(e/2-150,s/2-60,300,120,12);const n=this.add.text(e/2,s/2-15,t,{fontFamily:'"Microsoft YaHei", sans-serif',fontSize:"18px",color:"#ffffff"}).setOrigin(.5),r=this.add.text(e/2,s/2+30,"[ Á°ÆÂÆö ]",{fontFamily:'"Press Start 2P", monospace',fontSize:"14px",color:"#8fd464"}).setOrigin(.5).setInteractive({useHandCursor:!0});r.on("pointerover",()=>r.setColor("#aaffaa")),r.on("pointerout",()=>r.setColor("#8fd464")),r.on("pointerdown",()=>{i.destroy(),a.destroy(),n.destroy(),r.destroy()}),i.on("pointerdown",()=>{i.destroy(),a.destroy(),n.destroy(),r.destroy()})}showAboutDialog(){const{width:t,height:e}=this.scale,s=this.add.rectangle(t/2,e/2,t,e,0,.8).setInteractive(),i=this.add.graphics();i.fillStyle(1710638,1),i.fillRoundedRect(t/2-180,e/2-120,360,240,12),i.lineStyle(3,8174175,1),i.strokeRoundedRect(t/2-180,e/2-120,360,240,12);const a=this.add.text(t/2,e/2-85,"üéÆ CRAZY JUMPY",{fontFamily:'"Press Start 2P", monospace',fontSize:"16px",color:"#8fd464"}).setOrigin(.5),n=this.add.text(t/2,e/2,`‰∏ÄÊ¨æ‰ºëÈó≤Ë∑≥Ë∑ÉÊ∏∏Êàè

Êåâ‰ΩèÂ±èÂπïËìÑÂäõË∑≥Ë∑É
Âú®ÊúÄÈ´òÁÇπÂÜçÊ¨°Êåâ‰Ωè
ÂÆåÁæéÊó∂Êú∫ÈáäÊîæËé∑ÂæóÊúÄ‰Ω≥ÊïàÊûú

ÂáªÊùÄÊÄ™Áâ©Êî∂ÈõÜÊùêÊñôÔºÅ`,{fontFamily:'"Microsoft YaHei", sans-serif',fontSize:"14px",color:"#cccccc",align:"center",lineSpacing:6}).setOrigin(.5),r=this.add.text(t/2,e/2+85,"[ ÂÖ≥Èó≠ ]",{fontFamily:'"Press Start 2P", monospace',fontSize:"14px",color:"#8fd464"}).setOrigin(.5).setInteractive({useHandCursor:!0});r.on("pointerover",()=>r.setColor("#aaffaa")),r.on("pointerout",()=>r.setColor("#8fd464"));const o=()=>{s.destroy(),i.destroy(),a.destroy(),n.destroy(),r.destroy()};r.on("pointerdown",o),s.on("pointerdown",o)}}const h={gravity:1500,chargeEffect:{yOffset:-80},air:{baseFastFallAccel:4e3,fastFallRamp:15e3,maxFastFallAccel:6e4,releaseDecay:.05,terminalFallSpeed:15e3,terminalFastFallSpeed:2e5,fastFallChargeTime:.25,energyVyCap:6e3,energyAccelCap:6e3},ground:{impactScale:3e-5,maxDepth:150,compressTime:.12,compressLogScale:.5,yellowDuration0:.15,yellowDurationMin:.03,difficultyLogScale:.8,difficultyRefHeight:5e3,baseLaunchVelocity:-600,hardCapVelocity:5e4,peakEps:1,sweetHoldGrace0:.1,sweetHoldGraceMin:.02,failHoldTime0:.12,failHoldTimeMin:.03,overHoldAccelK0:8,overHoldAccelKGain:6,overHoldAccelTime:.25,deadEfficiency:.05,absorbRelaxTime:.02,settleEps:2,idleRelaxAfterPeak:.18,fatigueTime:.1,relaxTime:.2,releaseRecoverTime:.1,deformFollowTime:.02},cameraShake:{tauIn:.1,tauOut:.2,maxTotalAmpX:30,maxTotalAmpY:10,charge:{pStart:.72,pPeak:.9,approachPow:2,holdGamma:2.2,heightRef:5e3,xMax:2e4,k:1.5,ampXMax:12,ampYMax:2,freqMin:8,freqMax:18,postPeakTau:.1},air:{refHeight:3e3,maxHeight:2e4,pow:1.4,ampXMax:10,ampYMax:8,freqMin:2,freqMax:6}},groundShake:{heightRef:5e3,holdGamma:2.2,k:1.5,xMax:2e4,ampXMaxPx:6,ampYMaxPx:16,freqMin:12,freqMax:25,decayTau:.15,ripple:{radiusCols:8,impulseMaxPx:12,falloffPow:2,damping:8},globalClamp:30},milestone:{yOffset:30},display:{pixelsPerMeter:50,playerSize:200,playerCollisionRadius:100,playerYOffset:80,corpseYOffset:80,zoom:.85,skyGradientHeightOffset:200,healthBarWidth:84,healthBarHeight:12,healthBarOffsetY:-60},lane:{count:3,tweenDuration:100,tweenEase:"Quad.easeOut",swipeDistRatio:.03,moveTolRatio:.012,holdDelayMs:80,swipeCooldownMs:10},monster:{moveSpeedMin:25,moveSpeedMax:50,directionChangeInterval:2e3,directionChangeVariance:1500,a01:{frameRate:8,size:48},a02:{frameRate:10,size:48},a03:{frameRate:8,size:48},cloudA:{frameRate:10,size:52},director:{apexRangeStart:.85,apexRangeEndBase:.98,apexRangeEndMin:.91,apexRangeEndTau:600,minSpacingMeters:5,baseCount:4,maxCount:12,refHeightM:50,countGrowthFactor:2.5,speedRefHeightM:400,speedGrowthFactor:1.5,maxSpeedMultiplier:3,difficultyCurve:[[0,.9],[200,.9],[400,.5],[1e3,.4],[2e3,.3],[3e3,.2],[5e3,0]],dynamicSpacing:{baseSpacingM:4,heightRefM:600,heightFactor:.4,heightMaxBonus:1,sameSideBonus:1,diagonalBonus:1.2}}},bulletTime:{costPerUse:3,cooldown:.2,minActivationHeight:50,timeScaleMax:.42,timeScaleMin:.2,timeScaleTau:1500,baseDuration:3,maxExtraDuration:20,durationTau:800,maxEnergyBase:12,maxEnergyExtended:16,energyPerKill:.2,killRefundCap:1},ui:{heightText:{fontSizePercent:.08,maxFontSize:160,yOffset:80},bulletTimeIcon:{size:120,yOffset:210}}};class et{enter(t){const e=t.getGroundY();t.vy=0,t.y=e,t.currentCompression=0}update(t,e,s,i,a){const n=t.getGroundY();if(t.y=n,t.vy=0,t.currentCompression=t.approach(t.currentCompression,0,e,.08),i){if(t.transitionTo("AIRBORNE"),t.pendingTestJumpHeightPx>0){const r=h.gravity,o=t.pendingTestJumpHeightPx;t.vy=-Math.sqrt(2*r*o),t.pendingTestJumpHeightPx=0}else t.vy=-Math.abs(h.ground.baseLaunchVelocity);t.y=n-.5,t.prevVyForApex=t.vy,t.userAccel=0,t.holdTime=0}}exit(t){}}class st{enter(t){t.fallDistanceSinceApex=0,t.fastFallDistance=0,t.prevYForFall=t.y,t.fastFallEnergy=0,t.fastFallTime=0,t.vy<0&&t.resetLaneSwitchLock()}update(t,e,s,i,a){if(i&&(t.fastFallDistance=0),s){t.holdTime+=e;const d=Math.min(h.air.baseFastFallAccel+h.air.fastFallRamp*t.holdTime,h.air.maxFastFallAccel);t.userAccel=t.approach(t.userAccel,d,e,.05)}else t.holdTime=0,t.userAccel=t.approach(t.userAccel,0,e,h.air.releaseDecay);const n=h.gravity+t.userAccel;t.vy+=n*e;const r=h.air.terminalFallSpeed,o=h.air.terminalFastFallSpeed,l=s?o:r;t.vy>l&&(t.vy=l),t.y+=t.vy*e;const c=h.cameraShake;{const d=t.getGroundY(),g=Math.max(0,d-t.y),y=c.air;if(g>y.refHeight){const S=Math.log1p((g-y.refHeight)/y.refHeight),u=Math.log1p((y.maxHeight-y.refHeight)/y.refHeight),x=Phaser.Math.Clamp(S/u,0,1);t.airShake01=Math.pow(x,y.pow)}else t.airShake01=0}if(s&&t.vy>0&&t.userAccel>0){const d=h.air.energyVyCap,g=h.air.energyAccelCap,y=Math.min(t.vy,d),S=Math.min(t.userAccel,g);t.fastFallEnergy+=S*y*e,t.fastFallTime+=e}if(t.vy<0&&t.autoBTEligible){const d=t.launchY-t.y,g=d/Math.max(1,t.predictedApexHeight),y=d/h.display.pixelsPerMeter;if(!t.autoBTActivated&&g>=.8){t.autoBTActivated=!0;const S=t.predictedApexHeight/h.display.pixelsPerMeter,u=t.scene;u.bulletTimeManager&&!u.bulletTimeManager.isActive&&u.bulletTimeManager.forceActivateWithHeight(S,t.launchRating)}if(t.autoBTActivated){const S=t.scene;if(S.bulletTimeManager?.isActive&&S.monsterManager){const u=S.monsterManager.getAliveMonsterCount(),x=S.monsterManager.getHighestAliveMonsterHeight();let M=!1;u===0?M=!0:x>0&&y>x+2&&(M=!0,`${x.toFixed(0)}`),M&&S.bulletTimeManager.deactivate()}}}if(t.vy>0&&t.autoBTActivated){const d=t.scene;d.bulletTimeManager&&d.bulletTimeManager.isActive&&d.bulletTimeManager.deactivate(),t.autoBTActivated=!1,t.autoBTEligible=!1}if(t.prevVyForApex<0&&t.vy>=0){const d=t.getGroundY();t.lastApexHeight=Math.max(0,d-t.y),t.fastFallEnergy=0,t.fastFallTime=0,t.fallDistanceSinceApex=0,t.fastFallDistance=0,t.prevYForFall=t.y,t.lockLaneSwitch()}t.prevVyForApex=t.vy;const f=t.y-t.prevYForFall;f>0&&(t.fallDistanceSinceApex+=f,s&&(t.fastFallDistance+=f)),t.prevYForFall=t.y;const p=t.getGroundY();if(t.y>=p){t.y=p,t.impactSpeed=Math.max(0,t.vy),t.landingFallDistance=t.fallDistanceSinceApex,t.landingFastFallDistance=t.fastFallDistance,t.userAccel=0,t.holdTime=0;const d=h.ground.impactScale*(t.impactSpeed*t.impactSpeed);t.targetCompression=Math.min(d,h.ground.maxDepth),t.overflow=Math.max(0,d-h.ground.maxDepth),t.vy=0;const g=t.landingFallDistance>0?t.landingFallDistance:t.lastApexHeight;t.landingApexHeight=g;const S=h.ground.difficultyRefHeight;t.landingDifficulty=Math.max(1,t.landingApexHeight/Math.max(1,S));const u=h.groundShake;{const x=t.landingApexHeight,M=Math.max(1,t.landingFallDistance),w=t.landingFastFallDistance,T=Phaser.Math.Clamp(w/M,0,1),_=.3+.7*Math.pow(T,u.holdGamma),F=x/u.heightRef*_,R=Math.log1p(u.k*F),D=Math.log1p(u.k*(u.xMax/u.heightRef)),Y=Math.min(1,Math.abs(t.impactSpeed)/4e3);let E=Phaser.Math.Clamp(R/D,0,1);E*=.8+.2*Y,t.ground.onLandingImpact(t.x,Phaser.Math.Clamp(E,0,1))}t.scene.onPlayerLanded&&t.scene.onPlayerLanded(),t.transitionTo("GROUND_CHARGING")}}exit(t){}}class it{enter(t){t.currentCompression=0,t.reachedPeak=!1,t.chargeEfficiency=1,t.chargeProximity=0,t.chargeEffectFrame=1,t.chargeEffectState="idle",t.postPeakHoldTime=0,t.holdLockout=!1,t.contactHasInput=!1,t.startChargeEffect()}update(t,e,s,i,a){const n=t.getGroundY(),r=h.ground;s&&(t.contactHasInput=!0);const o=t.landingDifficulty??1,l=r.sweetHoldGrace0,c=r.sweetHoldGraceMin,f=m.Math.Clamp(l/o,c,l),p=r.failHoldTime0,d=r.failHoldTimeMin,g=m.Math.Clamp(p/o,d,p),y=r.overHoldAccelK0,S=r.overHoldAccelKGain,u=y+S*(o-1);if(!t.reachedPeak){const w=r.compressTime,T=r.compressLogScale,_=r.difficultyRefHeight,F=1+T*Math.log2(1+t.landingApexHeight/Math.max(1,_)),R=w*F;if(t.currentCompression=t.approach(t.currentCompression,t.targetCompression,e,R),t.currentCompression/Math.max(1e-6,t.targetCompression)>.9&&!t.isInYellowZone&&(t.isInYellowZone=!0,t.yellowZoneStartTime=0),t.isInYellowZone){t.yellowZoneStartTime+=e;const k=r.yellowDuration0,A=r.yellowDurationMin,O=r.difficultyLogScale,C=r.difficultyRefHeight,B=1+O*Math.log2(1+t.landingApexHeight/Math.max(1,C)),I=Math.max(A,k/B);t.yellowZoneStartTime>=I&&(t.reachedPeak=!0,t.postPeakHoldTime=0,t.holdLockout=!1,t.chargeEfficiency=1,t.currentCompression=t.targetCompression,t.isInYellowZone=!1)}const Y=r.peakEps;Math.abs(t.targetCompression-t.currentCompression)<=Y&&!t.reachedPeak&&(t.reachedPeak=!0,t.postPeakHoldTime=0,t.holdLockout=!1,t.chargeEfficiency=1,t.currentCompression=t.targetCompression,t.isInYellowZone=!1);const E=h.cameraShake;{const k=t.landingApexHeight,A=E.charge.heightRef,O=Math.max(1,t.landingFallDistance),C=t.landingFastFallDistance,B=m.Math.Clamp(C/O,0,1),I=m.Math.Clamp(t.currentCompression/Math.max(1e-6,t.targetCompression),0,1);t.chargeProximity=I;const V=k/A*Math.pow(B,E.charge.holdGamma),b=Math.log1p(E.charge.k*V),H=Math.log1p(E.charge.k*(E.charge.xMax/A)),L=m.Math.Clamp(b/H,0,1),P=E.charge.pStart,z=E.charge.pPeak;let G=0;if(I<P)G=0;else if(I>=z)G=1;else{const N=(I-P)/(z-P);G=N*N*(3-2*N)}if(t.reachedPeak){const N=Math.exp(-t.postPeakHoldTime/E.charge.postPeakTau);G*=N}const X=L*Math.pow(G,E.charge.approachPow);if(t.chargeShake01=m.Math.Clamp(X,0,1),t.chargeShake01>.01){const N=I>.95?1+(I-.95)*4:1,W=E.charge.ampXMax*.35*N,U=E.charge.ampYMax*.35*N,K=t.chargeShake01*t.chargeShake01;t.visualShakeX=(Math.random()-.5)*2*W*K,t.visualShakeY=(Math.random()-.5)*2*U*K}else t.visualShakeX=0,t.visualShakeY=0;t.ground.setChargeTremor(t.chargeShake01)}this.updateChargeTint(t),a&&t.contactHasInput&&this.tryLaunchActiveOrSettle(t);return}if(this.updateChargeTint(t),a&&t.contactHasInput){this.tryLaunchActiveOrSettle(t);return}if(!t.contactHasInput&&!s){const w=r.absorbRelaxTime;t.currentCompression=t.approach(t.currentCompression,0,e,w);const T=r.settleEps;if(t.currentCompression<=T){const F=100*h.display.pixelsPerMeter;t.landingApexHeight>F&&(t.healthManager.onLanding(t.landingApexHeight,"FAILED",!0),t.showFeedback("FAILED")),t.perfectStreak=0,t.transitionTo("GROUNDED_IDLE")}return}if(s){const w=r.settleEps;if(t.postPeakHoldTime+=e,t.postPeakHoldTime<=f){t.currentCompression=t.targetCompression,t.chargeEfficiency=1;return}const T=t.postPeakHoldTime-f,_=r.overHoldAccelTime,F=1+u*(1-Math.exp(-T/Math.max(1e-6,_)));T>=g&&(t.holdLockout=!0);const R=Math.max(1e-4,h.ground.relaxTime/F),D=Math.max(1e-4,h.ground.fatigueTime/F);if(t.currentCompression=t.approach(t.currentCompression,0,e,R),t.chargeEfficiency=t.approach(t.chargeEfficiency,0,e,D),t.y=n+t.currentCompression,t.currentCompression<=w){if(this.checkMissedBounceDeath(t))return;t.perfectStreak=0,t.transitionTo("GROUNDED_IDLE")}return}const x=r.idleRelaxAfterPeak;t.currentCompression=t.approach(t.currentCompression,0,e,x),t.y=n+t.currentCompression;const M=r.settleEps;t.currentCompression<=M&&(t.perfectStreak=0,t.transitionTo("GROUNDED_IDLE"))}exit(t){t.graphics.clearTint(),t.chargeShake01=0,t.visualShakeX=0,t.visualShakeY=0,t.ground.setChargeTremor(0)}checkMissedBounceDeath(t){if(!t.holdLockout)return!1;const e=h.display.pixelsPerMeter;return t.landingApexHeight/e>100?(t.healthManager.onLanding(t.landingApexHeight,"FAILED",!0),t.showFeedback("FAILED"),t.perfectStreak=0,t.transitionTo("GROUNDED_IDLE"),!0):!1}tryLaunchActiveOrSettle(t){const e=h.ground,s=e.settleEps;if(t.currentCompression<=s){t.perfectStreak=0,t.transitionTo("GROUNDED_IDLE");return}if(t.holdLockout){const a=h.display.pixelsPerMeter;t.landingApexHeight/a>100&&(t.healthManager.onLanding(t.landingApexHeight,"FAILED",!0),t.showFeedback("FAILED")),t.perfectStreak=0,t.transitionTo("GROUNDED_IDLE");return}const i=e.deadEfficiency;if(t.chargeEfficiency<=i){t.transitionTo("GROUNDED_IDLE");return}this.launchActiveControlled(t)}launchActiveControlled(t){const e=h.ground;let s;const i=t.currentCompression/Math.max(1e-6,t.targetCompression),a=t.isInYellowZone&&!t.reachedPeak,n=t.landingDifficulty??1,r=e.sweetHoldGrace0,o=e.sweetHoldGraceMin,l=m.Math.Clamp(r/n,o,r);t.holdLockout||t.chargeEfficiency<=e.deadEfficiency?s="FAILED":a||i>.9&&!t.reachedPeak||t.reachedPeak&&t.postPeakHoldTime<=l?s="PERFECT":s="NORMAL";const f=100*h.display.pixelsPerMeter,p=Math.max(1,t.landingFallDistance),g=(t.landingFastFallDistance||0)/p;t.landingApexHeight>f&&g<.3&&s==="PERFECT"&&(s="NORMAL");const y=h.gravity;let S;if(s==="PERFECT"?t.perfectStreak++:t.perfectStreak=0,t.healthManager.onLanding(t.lastApexHeight,s,t.holdLockout),t.healthManager.isDead){t.transitionTo("GROUNDED_IDLE");return}const u=t.perfectStreak>=3?2:1;if(s==="PERFECT"){const R=Math.max(1,t.landingFallDistance||t.lastApexHeight),D=Math.max(0,t.landingFastFallDistance||0),Y=m.Math.Clamp(D/R,0,1),E=h.gravity*R,k=m.Math.Clamp(t.fastFallEnergy/Math.max(1,E),0,1),A=h.air.fastFallChargeTime,O=m.Math.Clamp(A+5e-5*R,A,1.25),C=m.Math.Clamp(t.fastFallTime/Math.max(1e-6,O),0,1),B=m.Math.Clamp(k*Y*C,0,1),I=.15,V=.05*Math.log10(1+t.lastApexHeight/100),b=I+V,H=.85,L=u>1?1.5:1,P=1+b*L;let z=H+(P-H)*B;const G=50+t.lastApexHeight*.05;S=t.lastApexHeight*z+G*B}else if(s==="NORMAL"){const R=Math.max(1,t.landingFallDistance||t.lastApexHeight),D=Math.max(0,t.landingFastFallDistance||0),Y=m.Math.Clamp(D/R,0,1),E=.5,A=E+(.8-E)*Y;S=t.lastApexHeight*A}else S=t.lastApexHeight*.4;S=Math.max(S,50);let M=Math.sqrt(2*y*S);M=Math.max(M,Math.abs(h.ground.baseLaunchVelocity)),M=Math.min(M,h.ground.hardCapVelocity),t.showFeedback(s),t.groundRecoverTau=e.releaseRecoverTime,t.vy=-M;const w=h.gravity,T=M*M/(2*w),_=h.display.pixelsPerMeter,F=T/_;if(t.launchY=t.getGroundY(),t.predictedApexHeight=T,t.autoBTActivated=!1,t.launchRating=s,t.autoBTEligible=(s==="PERFECT"||s==="NORMAL")&&F>50,t.autoBTEligible){const R=t.scene;if(R.monsterManager){const D=s==="PERFECT"?1:.5;R.monsterManager.spawnApexMonsters(T,t.currentLane,D)}R.pickupManager&&(R.pickupManager.materialDropMultiplier=s==="PERFECT"?1:.5)}t.transitionTo("AIRBORNE"),t.currentCompression=0,t.y=t.getGroundY()-.5,t.contactHasInput=!1,t.reachedPeak=!1,t.postPeakHoldTime=0,t.holdLockout=!1,t.isInYellowZone=!1,t.prevVyForApex=t.vy}updateChargeTint(t){const e=t.chargeProximity??0;if(t.holdLockout)t.graphics.setTint(16729156);else if(t.isInYellowZone||t.reachedPeak){const s=Date.now()/1e3,i=.5+.5*Math.sin(s*12),a=Math.floor(255*(1-i*.3)),n=255,r=Math.floor(i*100),o=a<<16|n<<8|r;t.graphics.setTint(o)}else if(e>.3){const s=(e-.3)/.6,i=Math.floor(255-s*50),a=255,n=i,r=n<<16|a<<8|n;t.graphics.setTint(r)}else t.graphics.clearTint()}}class at{scene;invincible=!1;currentHealth=100;maxHealth=100;isDead=!1;healthBar;healthBarBg;damageText;damageTextTimer=0;healthBarVisibleTimer=0;HEALTH_BAR_SHOW_DURATION=1.5;SAFE_ZONE_METERS=100;INSTANT_DEATH_METERS=1e3;PIXELS_PER_METER=h.display.pixelsPerMeter;BAR_WIDTH=h.display.healthBarWidth;BAR_HEIGHT=h.display.healthBarHeight;BAR_OFFSET_Y=h.display.healthBarOffsetY;constructor(t){this.scene=t,this.createUI()}createUI(){this.healthBarBg=this.scene.add.graphics(),this.healthBarBg.setDepth(99),this.healthBar=this.scene.add.graphics(),this.healthBar.setDepth(100),this.damageText=this.scene.add.text(0,0,"",{fontSize:"32px",fontFamily:"Arial",fontStyle:"bold",color:"#ff0000",stroke:"#000000",strokeThickness:4}).setOrigin(.5).setDepth(101).setAlpha(0)}onLanding(t,e,s){if(this.isDead||this.invincible)return;const i=t/this.PIXELS_PER_METER;if(s&&i>this.SAFE_ZONE_METERS){this.die("Missed bounce timing!");return}if(e!=="PERFECT"&&!(i<=this.SAFE_ZONE_METERS)&&e==="NORMAL"){const a=this.calculateDamage(i);this.takeDamage(a)}}calculateDamage(t){if(t<=this.SAFE_ZONE_METERS)return 0;if(t>=this.INSTANT_DEATH_METERS)return this.currentHealth;const e=t-this.SAFE_ZONE_METERS,s=this.INSTANT_DEATH_METERS-this.SAFE_ZONE_METERS,i=100*(e/s);return Math.min(100,Math.max(0,i))}takeDamage(t){this.isDead||this.invincible||t<=0||(this.currentHealth=Math.max(0,this.currentHealth-t),this.showDamageText(Math.round(t)),this.healthBarVisibleTimer=this.HEALTH_BAR_SHOW_DURATION,this.currentHealth<=0&&this.die("Health depleted!"))}die(t){this.invincible||(this.isDead=!0,this.currentHealth=0)}showDamageText(t){this.damageTextTimer=1,this.damageText.setText(`-${t}`),this.damageText.setAlpha(1),this.damageText.setScale(1.5)}update(t,e,s){if(this.updateHealthBar(e,s,t),this.damageTextTimer>0){this.damageTextTimer-=t;const i=this.damageTextTimer/1,a=(1-i)*30;this.damageText.setPosition(e+60,s+this.BAR_OFFSET_Y-a),this.damageText.setAlpha(i),this.damageText.setScale(1.5-.5*(1-i))}else this.damageText.setAlpha(0)}updateHealthBar(t,e,s){const i=t-this.BAR_WIDTH/2,a=e+this.BAR_OFFSET_Y;if(this.healthBarBg.clear(),this.healthBar.clear(),this.healthBarVisibleTimer>0&&(this.healthBarVisibleTimer-=s),this.healthBarVisibleTimer<=0)return;let n=1;this.healthBarVisibleTimer<.3&&(n=this.healthBarVisibleTimer/.3),this.healthBarBg.fillStyle(0,.6*n),this.healthBarBg.fillRect(i-2,a-2,this.BAR_WIDTH+4,this.BAR_HEIGHT+4);const r=this.currentHealth/this.maxHealth,o=this.BAR_WIDTH*r;let l;r>.6?l=65280:r>.3?l=16776960:l=16711680,o>0&&(this.healthBar.fillStyle(l,n),this.healthBar.fillRect(i,a,o,this.BAR_HEIGHT))}reset(){this.currentHealth=this.maxHealth,this.isDead=!1,this.damageTextTimer=0,this.damageText.setAlpha(0)}setInvincible(t){this.invincible=t,t&&(this.isDead=!1,this.currentHealth=this.maxHealth,this.damageTextTimer=0,this.healthBarVisibleTimer=0,this.damageText.setAlpha(0))}applyUIScale(t){const e=Math.min(40,Math.floor(t*.08));this.damageText.setFontSize(e),this.damageText.setStroke("#000000",Math.max(3,e*.1))}destroy(){this.healthBar.destroy(),this.healthBarBg.destroy(),this.damageText.destroy()}}class nt{blocks=[];scene;y;width;startX;BLOCK_SIZE=64;LAYERS=8;BLOCKS_PER_ROW;yOffset=[];yVel=[];force=[];TENSION=180;STIFFNESS=90;DAMPING=18;MAX_OFFSET=60;shakeStrength01=0;shakePhase=0;shakeFreqHz=0;shakeDecayTau=.12;chargeStr=0;rippleOffset=[];rippleVel=[];constructor(t,e){this.scene=t,this.y=e,this.width=t.scale.width;const s=h.display.zoom,i=Math.max(this.width,this.scene.scale.height)/s,a=20;this.BLOCKS_PER_ROW=Math.ceil(i/this.BLOCK_SIZE*1.5)+a*2;const n=this.BLOCKS_PER_ROW*this.BLOCK_SIZE;this.startX=(this.width-n)/2;for(let r=0;r<this.BLOCKS_PER_ROW;r++)this.yOffset[r]=0,this.yVel[r]=0,this.force[r]=0,this.rippleOffset[r]=0,this.rippleVel[r]=0;this.createBlockGrid()}createBlockGrid(){for(let t=0;t<this.LAYERS;t++){this.blocks[t]=[];for(let e=0;e<this.BLOCKS_PER_ROW;e++){const s=this.startX+e*this.BLOCK_SIZE+this.BLOCK_SIZE/2,i=this.y+t*this.BLOCK_SIZE+this.BLOCK_SIZE/2,a=this.scene.add.image(s,i,"ground_block").setDisplaySize(this.BLOCK_SIZE,this.BLOCK_SIZE).setDepth(5-t*.1);this.blocks[t].push(a)}}}onLandingImpact(t,e){const s=h.groundShake;this.shakeStrength01=Math.max(this.shakeStrength01,e),this.shakeFreqHz=m.Math.Linear(s.freqMin,s.freqMax,e),this.shakePhase=Math.random()*Math.PI*2,this.shakeDecayTau=s.decayTau;{const i=Math.floor((t-this.startX)/this.BLOCK_SIZE),a=s.ripple.radiusCols;for(let n=Math.max(0,i-a);n<=Math.min(this.BLOCKS_PER_ROW-1,i+a);n++){const o=Math.abs(n-i)/a,l=Math.pow(1-o,s.ripple.falloffPow),c=e*s.ripple.impulseMaxPx*l;c>.5&&(this.rippleVel[n]+=c*20)}}}setChargeTremor(t){this.chargeStr=t}render(t,e,s){const i=h.groundShake;let a=0,n=0;if(this.shakeStrength01>.001){const c=Math.exp(-t/this.shakeDecayTau);this.shakeStrength01*=c,this.shakePhase+=Math.PI*2*this.shakeFreqHz*t,n=Math.sin(this.shakePhase)*i.ampYMaxPx*this.shakeStrength01,a=Math.sin(this.shakePhase*1.7+1.3)*i.ampXMaxPx*this.shakeStrength01}this.chargeStr>.01&&(n+=(Math.random()-.5)*4*this.chargeStr,a+=(Math.random()-.5)*2*this.chargeStr);{const c=i.globalClamp;a=m.Math.Clamp(a,-c,c),n=m.Math.Clamp(n,-c,c)}{const c=i.ripple.damping;for(let f=0;f<this.BLOCKS_PER_ROW;f++){const p=-120*this.rippleOffset[f]-c*this.rippleVel[f];this.rippleVel[f]+=p*t,this.rippleOffset[f]+=this.rippleVel[f]*t,Math.abs(this.rippleOffset[f])<.5&&Math.abs(this.rippleVel[f])<2&&(this.rippleOffset[f]=0,this.rippleVel[f]=0)}}const r=Math.floor(s!==void 0?(s-this.startX)/this.BLOCK_SIZE:this.BLOCKS_PER_ROW/2);for(let c=0;c<this.BLOCKS_PER_ROW;c++)this.force[c]=0;if(e>0){const f=e*80,p=6;for(let d=Math.max(0,r-p);d<=Math.min(this.BLOCKS_PER_ROW-1,r+p);d++){const g=d-r,y=Math.exp(-(g*g)/(2*1.6*1.6));this.force[d]+=f*y}}const o=2,l=t/o;for(let c=0;c<o;c++)for(let f=0;f<this.BLOCKS_PER_ROW;f++){const p=this.yOffset[f],d=this.yVel[f],g=this.yOffset[Math.max(0,f-1)],y=this.yOffset[Math.min(this.BLOCKS_PER_ROW-1,f+1)],S=g-2*p+y,u=this.TENSION*S-this.STIFFNESS*p-this.DAMPING*d+this.force[f];this.yVel[f]=d+u*l,this.yOffset[f]=p+this.yVel[f]*l,this.yOffset[f]=Math.max(-this.MAX_OFFSET*.3,Math.min(this.MAX_OFFSET,this.yOffset[f]))}for(let c=0;c<this.LAYERS;c++){const p=c===this.LAYERS-1?0:Math.exp(-c/2.2);for(let d=0;d<this.BLOCKS_PER_ROW;d++){const g=this.blocks[c][d],y=this.y+c*this.BLOCK_SIZE+this.BLOCK_SIZE/2,S=this.yOffset[d]*p,u=n*Math.max(.2,p),x=a*Math.max(.2,p),M=this.rippleOffset[d]*p,w=this.startX+d*this.BLOCK_SIZE+this.BLOCK_SIZE/2+x,T=y+S+u+M;g.setPosition(w,T)}}}getSurfaceOffsetAt(t){const e=Math.floor((t-this.startX)/this.BLOCK_SIZE),s=Math.max(0,Math.min(this.BLOCKS_PER_ROW-1,e));return this.yOffset[s]||0}}class rt{graphics;scene;x;y;vy=0;radius=h.display.playerCollisionRadius;state="AIRBORNE";ground;groundLevel;userAccel=0;holdTime=0;prevSpaceDown=!1;fastFallEnergy=0;fastFallTime=0;fallDistanceSinceApex=0;fastFallDistance=0;prevYForFall=0;landingFallDistance=0;landingFastFallDistance=0;impactSpeed=0;targetCompression=0;currentCompression=0;reachedPeak=!1;chargeEfficiency=1;overflow=0;contactHasInput=!1;postPeakHoldTime=0;holdLockout=!1;prevVyForApex=0;lastApexHeight=0;landingApexHeight=0;landingDifficulty=1;groundDeform=0;groundRecoverTau=.12;isInYellowZone=!1;yellowZoneStartTime=0;lastLaunchRating="";feedbackText;feedbackTimer=0;perfectStreak=0;comboText;comboTimer=0;predictedApexHeight=0;launchY=0;autoBTEligible=!1;autoBTActivated=!1;launchRating="PERFECT";poison1Duration=0;poison2Duration=0;poisonTickTimer=0;slowImpulseTimer=0;debuffGraceUntil=0;recentHitGraceUntil=0;swingGraceUntil=0;recentKilledIds=new Set;recentHitTimestamp=0;pendingTestJumpHeightPx=0;chargeEffectSprite;chargeEffectFrame=0;chargeEffectState="idle";chargeEffectTimer=0;chargeEffectDisplayScale=3;chargeEffectDisplayAlpha=1;RELEASE_START_FRAME=7;RELEASE_END_FRAME=11;RELEASE_FRAME_DURATION=.04;states;currentState;sparkEmitter;chargeShake01=0;airShake01=0;chargeProximity=0;visualShakeX=0;visualShakeY=0;healthManager;currentLane=1;targetLaneX=0;laneSwitchLocked=!1;laneTween;screenWidth=540;facingDirection=1;currentAnimation="";isPlayingAttackAnimation=!1;constructor(t,e,s,i){this.scene=t,this.x=e,this.y=s,this.ground=i,this.groundLevel=i.y;const a=h.display.playerSize;this.graphics=t.add.sprite(e,s,"cyclop").setDisplaySize(a,a).setDepth(10),this.playAnimation("idle"),this.vy=0,this.prevVyForApex=this.vy,this.prevYForFall=s,this.feedbackText=t.add.text(e,s-80,"",{fontSize:"64px",fontFamily:"Arial",fontStyle:"bold",color:"#ffffff",stroke:"#000000",strokeThickness:6}).setOrigin(.5).setDepth(100).setAlpha(0),this.comboText=t.add.text(e,s+50,"",{fontSize:"32px",fontFamily:"Arial",fontStyle:"bold",color:"#00ffff",stroke:"#000000",strokeThickness:4}).setOrigin(.5,.5).setDepth(100).setAlpha(0),this.sparkEmitter=t.add.particles(e,s,"spark",{speed:{min:50,max:150},angle:{min:0,max:360},scale:{start:.6,end:0},lifespan:400,frequency:30,quantity:2,tint:16776960,emitting:!1}).setDepth(15),this.chargeEffectSprite=t.add.sprite(e,s,"chargeup_1"),this.chargeEffectSprite.setOrigin(.5,1),this.chargeEffectSprite.setDepth(this.graphics.depth-1),this.chargeEffectSprite.setScale(3),this.chargeEffectSprite.setVisible(!1),this.vy=0,this.prevVyForApex=this.vy,this.prevYForFall=s;const n=h.ground;this.groundRecoverTau=n.releaseRecoverTime,this.healthManager=new at(t),this.states={GROUNDED_IDLE:new et,AIRBORNE:new st,GROUND_CHARGING:new it},this.state="GROUNDED_IDLE",this.currentState=this.states.GROUNDED_IDLE,this.currentState.enter(this),this.updateVisuals()}transitionTo(t){this.currentState.exit(this),this.state=t,this.currentState=this.states[t],this.currentState.enter(this)}update(t,e){const s=t/1e3,i=e&&!this.prevSpaceDown,a=!e&&this.prevSpaceDown;if(this.prevSpaceDown=e,this.currentState.update(this,s,e,i,a),this.updateDebuffs(s),this.state!=="AIRBORNE"){const n=this.getGroundY();this.y>n&&(this.y=n)}if(this.comboTimer>0){this.comboText.setPosition(this.x,this.y+50),this.comboTimer-=s;const n=this.comboTimer/1;if(n>.8){const r=1+(n-.8)/.2*.8;this.comboText.setScale(r),this.comboText.setAlpha(1)}else this.comboText.setScale(1),this.comboText.setAlpha(n/.8)}else this.comboText.setAlpha(0);if(this.feedbackTimer>0){this.feedbackText.setPosition(this.x,this.y-100),this.feedbackTimer-=s;const n=this.feedbackTimer/.8;if(n>.7){const o=1+(n-.7)/.3*1;this.feedbackText.setScale(o),this.feedbackText.setAlpha(1)}else n>0?(this.feedbackText.setScale(1),this.feedbackText.setAlpha(n/.7)):this.feedbackText.setAlpha(0)}this.updateChargeEffect(s),this.updateGroundDeform(s),this.updateVisuals(),this.updateAnimation(),this.healthManager.update(s,this.x,this.y)}showFeedback(t){if(this.lastLaunchRating=t,this.feedbackTimer=.8,this.feedbackText.setAlpha(1),this.feedbackText.setScale(2),this.feedbackText.setPosition(this.x,this.y-100),t==="PERFECT"){if(this.feedbackText.setText("PERFECT!"),this.feedbackText.setColor("#ffff00"),this.scene instanceof Z){const e=m.Math.Clamp(this.holdTime,0,5);this.scene.bulletTimeManager?.addEnergy(e)}this.completeChargeEffect()}else t==="NORMAL"?(this.feedbackText.setText("Normal"),this.feedbackText.setColor("#ffff00"),this.completeChargeEffect()):(this.feedbackText.setText("FAILED"),this.feedbackText.setColor("#ff0000"),this.cancelChargeEffect());t==="PERFECT"&&this.perfectStreak>1&&(this.comboTimer=1,this.comboText.setText(`${this.perfectStreak} COMBO!`),this.comboText.setColor("#00ffff"),this.comboText.setAlpha(1),this.comboText.setScale(1.8))}updateGroundDeform(t){const e=h.ground;if(this.state==="GROUND_CHARGING"){const s=e.deformFollowTime;this.groundDeform=this.approach(this.groundDeform,this.currentCompression,t,s)}else this.groundDeform=this.approach(this.groundDeform,0,t,this.groundRecoverTau),this.groundDeform<1e-4&&(this.groundDeform=0)}getGroundY(){const t=this.ground.getSurfaceOffsetAt(this.x);return this.groundLevel-this.radius+h.display.playerYOffset+t}approach(t,e,s,i){if(i<=0)return e;const a=1-Math.exp(-s/i);return t+(e-t)*a}updateVisuals(){if(this.graphics.setPosition(this.x,this.y),this.state==="AIRBORNE"){const n=Math.min(1,this.userAccel/h.air.maxFastFallAccel);if(n>.1){const o=Math.floor(255*(1-n*.7)),l=Math.floor(255*(1-n*.7));this.graphics.setTint(m.Display.Color.GetColor(255,o,l))}else this.graphics.clearTint()}else this.state==="GROUND_CHARGING"?this.holdLockout?this.graphics.setTint(3355443):this.reachedPeak&&this.postPeakHoldTime>(h.ground.sweetHoldGrace??.08)?this.graphics.setTint(6710886):this.currentCompression/(this.targetCompression+.1)>.9?this.graphics.setTint(16776960):this.graphics.clearTint():this.graphics.clearTint();const t=h.display.playerSize/32;let e=t,s=t;if(this.state==="GROUND_CHARGING"||this.state==="GROUNDED_IDLE"){const n=this.currentCompression/200,r=m.Math.Clamp(n,0,1.8);e=t*(1+r),s=t*(1-r*.5)}else{const n=Math.min(1.5,1+Math.abs(this.vy)/4e3);e=t/n,s=t*n}this.graphics.setScale(e,s);let i=this.x,a=this.y;(this.state==="GROUND_CHARGING"||this.state==="GROUNDED_IDLE")&&(a=this.getGroundY()+this.radius-s*32*.5),i+=this.visualShakeX,a+=this.visualShakeY,this.graphics.setPosition(i,a)}getCompression(){return this.groundDeform}applyUIScale(t){const e=Math.min(80,Math.floor(t*.15));this.feedbackText.setFontSize(e),this.feedbackText.setStroke("#000000",Math.max(4,e*.1));const s=Math.min(40,Math.floor(t*.08));this.comboText.setFontSize(s),this.comboText.setStroke("#000000",Math.max(3,s*.1)),this.healthManager.applyUIScale(t)}playDeathAnimation(t){this.graphics.stop(),this.currentAnimation="die",this.graphics.clearTint();const e=h.display.playerSize;this.graphics.setScale(e/32),this.graphics.play("die"),this.graphics.once("animationcomplete",()=>{t()}),this.sparkEmitter.stop(),this.comboText.setAlpha(0),this.feedbackText.setAlpha(0)}playAnimation(t){this.currentAnimation!==t&&(this.currentAnimation=t,this.graphics.play(t))}updateAnimation(){this.healthManager.isDead||this.isPlayingAttackAnimation||(this.state==="GROUNDED_IDLE"?this.facingDirection===-1?this.playAnimation("idle_left"):this.playAnimation("idle"):this.state==="AIRBORNE"?this.vy<0?this.facingDirection===-1?this.playAnimation("jump_rise_left"):this.playAnimation("jump_rise"):this.facingDirection===-1?this.playAnimation("jump_fall_left"):this.playAnimation("jump_fall"):this.state==="GROUND_CHARGING"&&(this.facingDirection===-1?this.playAnimation("jump_land_left"):this.playAnimation("jump_land")))}setScreenWidth(t){this.screenWidth=t,this.targetLaneX=this.getLaneCenterX(this.currentLane),this.x=this.targetLaneX}getLaneCenterX(t){const e=this.screenWidth/h.lane.count;return(t+.5)*e}requestLaneChange(t,e){if(this.state!=="AIRBORNE"||this.laneSwitchLocked)return!1;const s=this.currentLane+t;return s<0||s>=h.lane.count?!1:(this.currentLane=s,this.targetLaneX=this.getLaneCenterX(s),this.facingDirection=t,this.playAttackAnimation(t,e),this.laneTween&&this.laneTween.stop(),this.laneTween=this.scene.tweens.add({targets:this,x:this.targetLaneX,duration:h.lane.tweenDuration,ease:h.lane.tweenEase}),!0)}resetLaneSwitchLock(){this.laneSwitchLocked=!1}lockLaneSwitch(){this.laneSwitchLocked=!0}playAttackAnimation(t,e){this.isPlayingAttackAnimation=!0;const s=this.scene.time.now;this.addSwingGrace(250,s);const i=t===1?"attack_right":"attack_left";this.currentAnimation="",this.graphics.play(i);let a=!1;const n=()=>{const r=this.graphics.anims.currentFrame;r&&r.index===2&&!a&&(a=!0,e&&e(t,this.x,this.y),this.addSwingGrace(200,this.scene.time.now))};this.graphics.on("animationupdate",n),this.graphics.once("animationcomplete",()=>{this.isPlayingAttackAnimation=!1,this.graphics.off("animationupdate",n),this.facingDirection===-1?this.graphics.setTexture("jump_left_2"):this.graphics.setTexture("jump_2"),this.currentAnimation=""})}startChargeEffect(){this.chargeEffectState="charging",this.chargeEffectFrame=1,this.chargeEffectTimer=0,this.chargeEffectSprite.setTexture("chargeup_1"),this.chargeEffectSprite.setDepth(this.graphics.depth-1),this.chargeEffectDisplayScale=3,this.chargeEffectDisplayAlpha=1,this.chargeEffectSprite.setVisible(!0)}completeChargeEffect(){(this.chargeEffectState==="charging"||this.chargeEffectState==="holding")&&(this.chargeEffectState="releasing",this.chargeEffectTimer=0,this.chargeEffectFrame=Math.max(this.RELEASE_START_FRAME,this.chargeEffectFrame),this.chargeEffectSprite.setTexture(`chargeup_${this.chargeEffectFrame}`))}cancelChargeEffect(){this.chargeEffectState="idle",this.chargeEffectSprite.setVisible(!1)}updateChargeEffect(t){if(this.state!=="GROUND_CHARGING"&&this.chargeEffectState!=="releasing"){this.chargeEffectState="idle",this.chargeEffectSprite.setVisible(!1);return}const e=this.getGroundY()+this.radius,s=h.chargeEffect?.yOffset;switch(this.chargeEffectSprite.setPosition(this.graphics.x,e+s),this.chargeEffectSprite.setDepth(this.graphics.depth-1),this.chargeEffectState){case"idle":break;case"charging":case"holding":{if(this.state!=="GROUND_CHARGING"){this.cancelChargeEffect();break}const i=m.Math.Clamp(this.chargeProximity??0,0,1),a=[0,.5,.65,.78,.88],n=.03;let r=this.chargeEffectFrame||1;const o=this.isInYellowZone||this.reachedPeak;if(o)r=6;else{for(let g=1;g<=5;g++)i>=a[g-1]&&(r=g);const d=Math.max(1,Math.min(this.chargeEffectFrame||1,5))-1;if(i<a[d]-n&&d>0){for(let g=5;g>=1;g--)if(i>=a[g-1]-n){r=g;break}}}r!==this.chargeEffectFrame&&(this.chargeEffectFrame=r,this.chargeEffectSprite.setTexture(`chargeup_${this.chargeEffectFrame}`));const l=3,c=1+.28*i*i;let f=l*c;if(o){const d=1+.08*Math.sin(this.scene.time.now*.025);f*=d}const p=.55+.45*i;this.chargeEffectDisplayScale=m.Math.Linear(this.chargeEffectDisplayScale,f,.35),this.chargeEffectDisplayAlpha=m.Math.Linear(this.chargeEffectDisplayAlpha,p,.35),this.chargeEffectSprite.setScale(this.chargeEffectDisplayScale),this.chargeEffectSprite.setAlpha(this.chargeEffectDisplayAlpha),this.reachedPeak&&(this.chargeEffectState="holding");break}case"releasing":this.chargeEffectTimer+=t,this.chargeEffectTimer>=this.RELEASE_FRAME_DURATION&&(this.chargeEffectTimer=0,this.chargeEffectFrame<this.RELEASE_END_FRAME?(this.chargeEffectFrame++,this.chargeEffectSprite.setTexture(`chargeup_${this.chargeEffectFrame}`)):(this.chargeEffectState="idle",this.chargeEffectSprite.setVisible(!1)));break}}applyDebuffFromMonster(t,e=1){const s=this.scene.time.now;if(!this.hasRecentHitWindow(s))switch(t){case"A01":this.poison1Duration=Math.min(5,this.poison1Duration+e);break;case"A02":this.poison2Duration=Math.min(5,this.poison2Duration+e),console.log(`[Slime] ‰∏≠ÊØíII +${e}Áßí, ÊÄªËÆ°${this.poison2Duration.toFixed(1)}Áßí`);break;case"CloudA":{this.vy*=.6,this.slowImpulseTimer=.4;break}}}updateDebuffs(t){if(this.poison1Duration<=0&&this.poison2Duration<=0&&this.slowImpulseTimer<=0)return;if(this.poison1Duration>0&&(this.poison1Duration=Math.max(0,this.poison1Duration-t)),this.poison2Duration>0&&(this.poison2Duration=Math.max(0,this.poison2Duration-t)),this.slowImpulseTimer>0&&(this.slowImpulseTimer=Math.max(0,this.slowImpulseTimer-t)),!(this.poison1Duration>0||this.poison2Duration>0)){this.poisonTickTimer=0;return}for(this.poisonTickTimer+=t;this.poisonTickTimer>=1;){this.poisonTickTimer-=1;const s=(this.poison1Duration>0?1:0)+(this.poison2Duration>0?2:0);s>0&&this.healthManager&&!this.healthManager.isInfiniteHealth&&this.healthManager.takeDamage(s)}this.recentKilledIds.size>0&&this.recentHitTimestamp>0&&this.scene.time.now-this.recentHitTimestamp>1e3&&this.recentKilledIds.clear()}addDebuffGrace(t,e){this.debuffGraceUntil=Math.max(this.debuffGraceUntil,e+t)}hasDebuffGrace(t){return t<=this.debuffGraceUntil}addRecentHitGrace(t,e){this.recentHitGraceUntil=Math.max(this.recentHitGraceUntil,e+t),this.recentHitTimestamp=e}hasRecentHitGrace(t){return t<=this.recentHitGraceUntil}addSwingGrace(t,e){this.swingGraceUntil=Math.max(this.swingGraceUntil,e+t)}hasSwingGrace(t){return t<=this.swingGraceUntil}addRecentKill(t,e){this.recentKilledIds.add(t),this.recentHitTimestamp=e}hasRecentHitWindow(t,e=250){return t-this.recentHitTimestamp<=e}clearOldKills(t){this.recentKilledIds.size!==0&&t-this.recentHitTimestamp>1e3&&this.recentKilledIds.clear()}}class ot{currentChargeIntensity=0;currentAirIntensity=0;time=0;shakeX=0;shakeY=0;constructor(){}update(t,e,s){const i=h.cameraShake,a=e>this.currentChargeIntensity?i.tauIn:i.tauOut;this.currentChargeIntensity=this.approach(this.currentChargeIntensity,e,t,a);const n=s>this.currentAirIntensity?i.tauIn:i.tauOut;this.currentAirIntensity=this.approach(this.currentAirIntensity,s,t,n),this.time+=t;let r=0,o=0;if(this.currentChargeIntensity>.001){const d=i.charge,g=this.lerp(d.freqMin,d.freqMax,this.currentChargeIntensity),y=this.currentChargeIntensity*this.currentChargeIntensity,S=d.ampXMax*y,u=d.ampYMax*y;r=(Math.sin(this.time*g)+.5*Math.sin(this.time*g*1.3+1.2))*S,o=(Math.sin(this.time*g*1.1+2.4)+.5*Math.cos(this.time*g*.9))*u}let l=0,c=0;if(this.currentAirIntensity>.001){const d=i.air,g=this.lerp(d.freqMin,d.freqMax,this.currentAirIntensity),y=this.currentAirIntensity,S=d.ampXMax*y,u=d.ampYMax*y;l=(Math.sin(this.time*g)+.8*Math.sin(this.time*g*.4+4.1))*S,c=Math.sin(this.time*g*.7+1.2)*.6*u}const f=r+l,p=o+c;this.shakeX=m.Math.Clamp(f,-30,i.maxTotalAmpX),this.shakeY=m.Math.Clamp(p,-10,i.maxTotalAmpY)}lerp(t,e,s){return t+(e-t)*s}approach(t,e,s,i){if(i<=0)return e;const a=1-Math.exp(-s/i);return t+(e-t)*a}}class ct{static MAX_GAME_METERS=3500;static MAX_VIRT_KM=120;static CURVE_SCALE=500;static mapGameMetersToVirtualKm(t){const e=Math.max(0,Math.min(this.MAX_GAME_METERS,t)),s=Math.log(1+e/this.CURVE_SCALE),i=Math.log(1+this.MAX_GAME_METERS/this.CURVE_SCALE),a=s/i;return this.MAX_VIRT_KM*a}static mapGameMetersToT(t){const e=this.mapGameMetersToVirtualKm(t);return Math.max(0,Math.min(1,e/this.MAX_VIRT_KM))}static getLayerName(t){const e=this.mapGameMetersToVirtualKm(t);return e<2?"Planetary Boundary Layer":e<12?"Troposphere":e<50?"Stratosphere":e<85?"Mesosphere":e<100?"Near Space":"Outer Space"}static getDebugInfo(t){const e=this.mapGameMetersToVirtualKm(t),s=this.mapGameMetersToT(t);return{gameMeters:Math.round(t*10)/10,virtualKm:Math.round(e*100)/100,t:Math.round(s*1e3)/1e3,layer:this.getLayerName(t),progressPercent:Math.round(s*100)}}static getTestMilestones(){return[{height:0,desc:"Ground - hazy/warm"},{height:100,desc:"Early jump - haze clearing"},{height:250,desc:"Low altitude - entering blue"},{height:500,desc:"Quarter mark - clear blue sky"},{height:1e3,desc:"Mid-low - sky darkening"},{height:1500,desc:"Mid point - deep blue"},{height:2e3,desc:"Mid-high - indigo transition"},{height:2500,desc:"High - navy blue"},{height:3e3,desc:"Very high - near black"},{height:3500,desc:"Maximum - pure space black"}].map(e=>({height:e.height,virtKm:Math.round(this.mapGameMetersToVirtualKm(e.height)*100)/100,description:e.desc}))}}class ht{scene;lutKey;groundYpx;pxPerMeter;smoothFactor;lutColors=[];lutHeight=0;currentColor=8900331;targetColor=8900331;constructor(t,e="Ê∏êÂèòËâ≤Ë∞ÉÂõæ",s,i=50,a=.08){this.scene=t,this.lutKey=e,this.groundYpx=s,this.pxPerMeter=i,this.smoothFactor=a,this.initialize()}initialize(){const t=this.scene.textures.get(this.lutKey);if(!t||t.key==="__MISSING"){console.error(`[SkyGradientLUT] Texture "${this.lutKey}" not found!`);return}const e=t.getSourceImage();if(!e){console.error("[SkyGradientLUT] Failed to get source image");return}const s=document.createElement("canvas"),i=s.getContext("2d",{willReadFrequently:!1});if(!i){console.error("[SkyGradientLUT] Failed to get canvas context");return}s.width=e.width,s.height=e.height,i.drawImage(e,0,0),this.lutHeight=e.height;const a=Math.floor(e.width/2),r=i.getImageData(a,0,1,this.lutHeight).data;this.lutColors=[];for(let o=0;o<this.lutHeight;o++){const l=o*4,c=r[l],f=r[l+1],p=r[l+2],d=c<<16|f<<8|p;this.lutColors.push(d)}this.update(this.groundYpx),this.currentColor=this.targetColor,this.applyBackgroundColor()}update(t){if(this.lutColors.length===0)return;const s=(this.groundYpx-t)/this.pxPerMeter,i=h.display.skyGradientHeightOffset,a=s+i,n=ct.mapGameMetersToT(a),r=Math.round((1-n)*(this.lutHeight-1)),o=Math.max(0,Math.min(this.lutHeight-1,r));this.targetColor=this.lutColors[o],this.currentColor=this.lerpColor(this.currentColor,this.targetColor,this.smoothFactor),this.applyBackgroundColor()}applyBackgroundColor(){this.scene.cameras.main.setBackgroundColor(this.currentColor)}lerpColor(t,e,s){const i=t>>16&255,a=t>>8&255,n=t&255,r=e>>16&255,o=e>>8&255,l=e&255,c=Math.round(i+(r-i)*s),f=Math.round(a+(o-a)*s),p=Math.round(n+(l-n)*s);return c<<16|f<<8|p}setGroundY(t){this.groundYpx=t}destroy(){this.lutColors=[]}}const j={CANDIDATE:"CANDIDATE",SWIPE:"SWIPE",HOLD:"HOLD"};class lt{pointers=new Map;lastSwipeTime=0;swipeDist=18;moveTol=8;holdDelay=80;swipeCooldown=120;_laneSwitchLocked=!1;constructor(t=540){this.updateScreenWidth(t)}updateScreenWidth(t){const e=h.lane;this.swipeDist=Math.max(18,t*e.swipeDistRatio),this.moveTol=Math.max(8,t*e.moveTolRatio),this.holdDelay=e.holdDelayMs,this.swipeCooldown=e.swipeCooldownMs}onPointerDown(t,e,s,i){this.pointers.set(t,{id:t,startX:e,startY:s,startTime:i,currentX:e,currentY:s,intent:j.CANDIDATE,swipeConsumed:!1,holdLocked:!1})}onPointerMove(t,e,s){const i=this.pointers.get(t);i&&(i.currentX=e,i.currentY=s)}onPointerUp(t){this.pointers.delete(t)}clearAll(){this.pointers.clear()}resetLaneSwitchLock(){this._laneSwitchLocked=!1}update(t){let e=!1,s=0;for(const i of this.pointers.values()){const a=i.currentX-i.startX,n=i.currentY-i.startY,r=t-i.startTime;if(i.intent===j.HOLD){e=!0,this._laneSwitchLocked=!0;continue}if(i.intent===j.SWIPE)continue;const o=Math.abs(a),l=Math.abs(n);if(o>=this.swipeDist&&o>l){i.intent=j.SWIPE,!i.swipeConsumed&&!this._laneSwitchLocked&&t-this.lastSwipeTime>=this.swipeCooldown&&(s=a>0?1:-1,i.swipeConsumed=!0,this.lastSwipeTime=t);continue}r>=this.holdDelay&&o<this.moveTol&&l<this.moveTol&&(i.intent=j.HOLD,i.holdLocked=!0,e=!0,this._laneSwitchLocked=!0)}return{isHoldActive:e,swipeDirection:s,laneSwitchLocked:this._laneSwitchLocked}}hasActivePointers(){return this.pointers.size>0}getPointerCount(){return this.pointers.size}}class ${static NEXT_ID=1;scene;sprite;id;x;y;heightMeters;type;isAlive=!0;nextDebuffTime=0;noDebuffUntil=0;currentLane=1;screenWidth;moveDirection=1;moveSpeed=40;speedMultiplier=1;nextDirectionChange=0;isChasing=!1;chaseCurrentSpeed=0;constructor(t,e,s){this.scene=t,this.id=$.NEXT_ID++,this.x=e.x,this.y=e.y,this.heightMeters=e.heightMeters,this.type=e.type,this.screenWidth=s,this.speedMultiplier=e.speedMultiplier??1;const a=this.getTypeConfig().size;let n;switch(this.type){case"A02":n="monster_a02_right_1";break;case"A03":n="monster_a03_right_1";break;case"CloudA":n="monster_clouda_right_1";break;default:n="monster_a01_right_1";break}this.sprite=t.add.sprite(this.x,this.y,n).setDisplaySize(a,a).setDepth(5),this.moveDirection=Math.random()>.5?1:-1,this.updateMoveSpeed(),this.scheduleDirectionChange(),this.updateCurrentLane(),this.playDirectionAnimation(),this.type==="A02"&&console.log(`[A02] ÂàõÂª∫ËùôËù†! Y=${this.y.toFixed(0)}, È´òÂ∫¶=${this.heightMeters}m`)}getTypeConfig(){switch(this.type){case"A02":return{size:h.monster.a02?.size,frameRate:h.monster.a02?.frameRate};case"A03":return{size:h.monster.a03?.size,frameRate:h.monster.a03?.frameRate};case"CloudA":return{size:h.monster.cloudA?.size,frameRate:h.monster.cloudA?.frameRate};default:return{size:h.monster.a01?.size,frameRate:h.monster.a01?.frameRate}}}updateMoveSpeed(){const t=m.Math.Between(h.monster.moveSpeedMin,h.monster.moveSpeedMax),e=this.type==="A02"?1.3:1;this.moveSpeed=t*this.speedMultiplier*e}update(t,e,s,i){if(!this.isAlive)return;if(this.type==="A02"&&s!==void 0&&i!==void 0){if(i<this.y-30&&!this.isChasing&&(this.isChasing=!0,this.chaseCurrentSpeed=0),this.isChasing){this.sprite.setTint(16711680);const f=s-this.x,p=i-this.y,d=Math.sqrt(f*f+p*p);if(d>5){this.chaseCurrentSpeed=Math.min(this.chaseCurrentSpeed+12e3*t,3e3);const u=Math.max(1e3,this.chaseCurrentSpeed),x=f/d,M=p/d;this.x+=x*u*t,this.y+=M*u*t}}else{e>=this.nextDirectionChange&&this.changeDirection();const f=this.moveDirection*this.moveSpeed*t;this.x+=f;const p=h.lane.count,d=this.screenWidth/p,g=this.currentLane*d+d*.25,y=(this.currentLane+1)*d-d*.25;this.x<g?(this.x=g,this.changeDirection()):this.x>y&&(this.x=y,this.changeDirection())}this.sprite.setPosition(this.x,this.y);return}e>=this.nextDirectionChange&&this.changeDirection();const a=this.moveDirection*this.moveSpeed*t;this.x+=a;const n=h.lane.count,r=this.screenWidth/n,o=this.currentLane*r+r*.25,l=(this.currentLane+1)*r-r*.25;this.x<o?(this.x=o,this.changeDirection()):this.x>l&&(this.x=l,this.changeDirection()),this.sprite.setPosition(this.x,this.y)}updateCurrentLane(){const t=this.screenWidth/h.lane.count,e=Math.floor(this.x/t);this.currentLane=m.Math.Clamp(e,0,h.lane.count-1)}changeDirection(){this.moveDirection=this.moveDirection===1?-1:1,this.updateMoveSpeed(),this.scheduleDirectionChange(),this.type==="CloudA"?(this.sprite.setTexture("monster_clouda_middle"),this.scene.time.delayedCall(80,()=>{this.isAlive&&this.playDirectionAnimation()})):this.playDirectionAnimation()}scheduleDirectionChange(){const t=h.monster.directionChangeInterval,e=h.monster.directionChangeVariance,s=t+m.Math.Between(-e,e);this.nextDirectionChange=this.scene.time.now+Math.max(500,s)}isInChaseMode(){return this.type==="A02"&&this.isChasing}playDirectionAnimation(){let t;switch(this.type){case"A02":t="monster_a02";break;case"A03":t="monster_a03";break;case"CloudA":t="monster_clouda";break;default:t="monster_a01";break}const e=this.moveDirection===1?`${t}_right`:`${t}_left`;this.sprite.anims.currentAnim?.key!==e&&this.sprite.play(e)}kill(){this.isAlive&&(this.isAlive=!1,this.scene.tweens.add({targets:this.sprite,alpha:0,scale:1.5,duration:200,onComplete:()=>{this.sprite.destroy()}}))}destroy(){this.isAlive=!1,this.sprite.destroy()}}class ft{scene;sprite;type;isAlive=!0;x;y;state="ejecting";stateTimer=0;attractEnabled=!0;collectEnabled=!0;stayOnGround=!1;fallingVy=0;ejectDuration=.4;ejectVx=0;ejectVy=0;ejectFriction=8;groundY=1/0;useDeathEject=!1;baseChaseSpeed=1e3;chaseSpeedMultiplier=2;chaseAccel=12e3;currentSpeed=0;pickupRadius=25;constructor(t,e){this.scene=t,this.type=e.type,this.x=e.x,this.y=e.y;let s,i;switch(e.type){case"coin":s="pickup_coin",i=28;break;case"gem":s="pickup_gem",i=32;break;case"wing":s="pickup_wing",i=36;break}if(this.sprite=t.add.sprite(this.x,this.y,s),this.sprite.setDisplaySize(i,i),this.sprite.setDepth(150),e.ejectVxOverride!==void 0&&e.ejectVyOverride!==void 0)this.ejectVx=e.ejectVxOverride,this.ejectVy=e.ejectVyOverride,this.useDeathEject=!0,this.groundY=e.groundY??1/0,this.ejectDuration=5,this.sprite.setDepth(1999);else{const a=Math.random()*Math.PI*2,n=200+Math.random()*150;this.ejectVx=Math.cos(a)*n,this.ejectVy=Math.sin(a)*n-200}this.sprite.setScale(0),t.tweens.add({targets:this.sprite,scaleX:i/this.sprite.width,scaleY:i/this.sprite.height,duration:150,ease:"Back.easeOut"}),this.sprite.setTint(16777130),e.noAttractDelay&&e.noAttractDelay>0&&(this.attractEnabled=!1,this.collectEnabled=!1,this.stateTimer=-e.noAttractDelay),e.disableAttract&&(this.attractEnabled=!1,this.collectEnabled=!1),this.stayOnGround=!!e.stayOnGround}update(t,e,s,i=0){if(!this.isAlive)return!0;switch(this.stateTimer+=t,this.state){case"ejecting":return this.updateEjecting(t);case"chasing":return this.updateChasing(t,e,s,i);case"grounded":return this.updateGrounded(t);case"falling":return this.updateFalling(t)}}updateFalling(t){this.fallingVy=Math.min(this.fallingVy+2500*t,6e3),this.y+=this.fallingVy*t,this.sprite.x=this.x,this.sprite.y=this.y;const n=(this.scene.groundY??768)-20;return this.y>=n&&(this.y=n,this.sprite.y=this.y,this.state="grounded",this.fallingVy=0),!1}updateEjecting(t){if(this.stateTimer<0)return!1;if(this.useDeathEject){this.x+=this.ejectVx*t,this.y+=this.ejectVy*t;const e=1800;this.ejectVy+=e*t,this.ejectVx*=Math.exp(-2*t),this.sprite.x=this.x,this.sprite.y=this.y,this.sprite.angle+=this.ejectVx*.5*t;const s=this.groundY-20;return this.y>=s&&(this.y=s,this.sprite.y=this.y,this.sprite.angle=0,this.sprite.clearTint(),this.state="grounded",this.stateTimer=0,this.attractEnabled=!1,this.collectEnabled=!1),!1}return this.x+=this.ejectVx*t,this.y+=this.ejectVy*t,this.ejectVx*=Math.exp(-this.ejectFriction*t),this.ejectVy*=Math.exp(-this.ejectFriction*t),this.ejectVy+=500*t,this.sprite.x=this.x,this.sprite.y=this.y,this.sprite.angle+=360*t,this.stateTimer>=this.ejectDuration&&(this.state="chasing",this.stateTimer=0,this.sprite.clearTint(),this.sprite.angle=0,this.scene.tweens.add({targets:this.sprite,y:this.y-6,duration:400,yoyo:!0,repeat:2,ease:"Sine.easeInOut"})),!1}updateChasing(t,e,s,i){if(!this.attractEnabled)return this.state="falling",this.fallingVy=0,!1;const a=e-this.x,n=s-this.y,r=Math.sqrt(a*a+n*n);if(r<this.pickupRadius&&this.collectEnabled)return this.collect(),!0;let o=this.baseChaseSpeed+Math.abs(i)*this.chaseSpeedMultiplier;const l=100;if(r<l){const c=1+2*(1-r/l);o*=c;const f=.5+.5*(r/l);this.sprite.setScale(this.sprite.scaleX*f)}if(this.currentSpeed=Math.min(this.currentSpeed+this.chaseAccel*t,o),r>0){const c=a/r,f=n/r;this.x+=c*this.currentSpeed*t,this.y+=f*this.currentSpeed*t,this.scene.tweens.killTweensOf(this.sprite),this.sprite.x=this.x,this.sprite.y=this.y}return!1}updateGrounded(t){return this.stayOnGround?this.sprite.y=this.y:this.sprite.y=this.y+Math.sin(this.scene.time.now*.005)*3,!1}collect(){this.isAlive=!1,this.scene.tweens.killTweensOf(this.sprite),this.scene.tweens.add({targets:this.sprite,scaleX:this.sprite.scaleX*1.5,scaleY:this.sprite.scaleY*1.5,alpha:0,duration:120,ease:"Power2",onComplete:()=>{this.sprite.destroy()}})}disableAttract(){this.useDeathEject&&this.state==="ejecting"||(this.attractEnabled=!1,this.collectEnabled=!1,(this.state==="chasing"||this.state==="ejecting")&&(this.state="falling",this.fallingVy=0))}enableAttract(){this.useDeathEject||(this.attractEnabled=!0,this.collectEnabled=!0,this.state==="grounded"&&(this.state="chasing",this.stateTimer=0))}destroy(){this.isAlive=!1,this.scene.tweens.killTweensOf(this.sprite),this.sprite.destroy()}}class dt{columns=4;rows=4;stackSize=10;unlockedSlots=2;slots;pickupManager=null;constructor(){this.slots=Array.from({length:this.columns*this.rows},()=>({type:null,count:0}))}isSlotUnlocked(t){return t<this.unlockedSlots}setPickupManager(t){this.pickupManager=t}getSlots(){return this.slots}canAdd(t,e){let s=e;for(let n=0;n<this.unlockedSlots;n++){const r=this.slots[n];if(r.type===t&&r.count<this.stackSize){const o=this.stackSize-r.count;if(s-=o,s<=0)return!0}}let i=0;for(let n=0;n<this.unlockedSlots;n++){const r=this.slots[n];(!r.type||r.count===0)&&i++}const a=i*this.stackSize;return s<=a}add(t,e){console.log("[InventoryManager] add:",t,e);let s=e;for(let i=0;i<this.unlockedSlots&&!(s<=0);i++){const a=this.slots[i];if(a.type===t&&a.count<this.stackSize){const n=this.stackSize-a.count,r=Math.min(n,s);a.count+=r,s-=r}}for(let i=0;i<this.unlockedSlots&&!(s<=0);i++){const a=this.slots[i];if(!a.type||a.count===0){const n=Math.min(this.stackSize,s);a.type=t,a.count=n,s-=n}}return{added:e-s,left:s}}remove(t,e){let s=e;for(const i of this.slots){if(s<=0)break;if(i.type===t&&i.count>0){const a=Math.min(i.count,s);i.count-=a,s-=a,i.count===0&&(i.type=null)}}return e-s}clear(){for(const t of this.slots)t.type=null,t.count=0}dropAll(t,e,s,i){if(!this.pickupManager)return console.warn("[InventoryManager] dropAll: pickupManager not set!"),0;const a=this.pickupManager,n=i??s+50,r=[];for(const u of this.slots)u.type&&u.count>0&&r.push({type:u.type,count:u.count});if(console.log("[InventoryManager] dropAll: allItems =",r,"total slots with items:",r.length),r.length===0)return console.log("[InventoryManager] dropAll: No items to drop"),this.clear(),0;let o=0;for(const u of r)o+=u.count;const l=180,c=-350,f=80,p=80;console.log("[InventoryManager] dropAll: Starting to spawn",o,"items at x:",e.toFixed(0),"y:",s.toFixed(0),"groundY:",n.toFixed(0));let d=0;for(const u of r)for(let x=0;x<u.count;x++){const w=(d%2===0?-1:1)*(l+m.Math.FloatBetween(-f,f)),T=c+m.Math.FloatBetween(-p,p),_=u.type,F=e,R=s-20,D=Math.min(R,n-100);console.log("[InventoryManager] Spawning item",d,":",_,"at y:",D.toFixed(0),"vx:",w.toFixed(0),"vy:",T.toFixed(0)),a.spawn(_,F,D,{disableAttract:!0,stayOnGround:!1,ejectVxOverride:w,ejectVyOverride:T,groundY:n}),d++}return this.clear(),(o-1)*8+600+200}}class pt{scene;pickups=[];inventory=null;coins=0;gems=0;wings=0;constructor(t){this.scene=t}setInventoryManager(t){this.inventory=t}spawn(t,e,s,i){const a=new ft(this.scene,{type:t,x:e,y:s,noAttractDelay:i?.noAttractDelay,disableAttract:i?.disableAttract,stayOnGround:i?.stayOnGround,ejectVxOverride:i?.ejectVxOverride,ejectVyOverride:i?.ejectVyOverride,groundY:i?.groundY});this.pickups.push(a)}materialDropMultiplier=1;spawnMonsterDrops(t,e,s="A01"){const i=this.materialDropMultiplier;s==="A01"?(this.spawnWithOffset("coin",t,e),Math.random()<.5*i&&this.spawnWithOffset("gem",t,e)):s==="A02"?(this.spawnWithOffset("coin",t,e),Math.random()<.6&&this.spawnWithOffset("coin",t,e),Math.random()<.2*i&&this.spawnWithOffset("wing",t,e)):s==="A03"?(this.spawnWithOffset("coin",t,e),this.spawnWithOffset("coin",t,e),Math.random()<.4*i&&this.spawnWithOffset("wing",t,e)):s==="CloudA"?(this.spawnWithOffset("coin",t,e),Math.random()<.35*i&&this.spawnWithOffset("gem",t,e)):this.spawnWithOffset("coin",t,e)}spawnWithOffset(t,e,s){const i=m.Math.FloatBetween(-20,20),a=m.Math.FloatBetween(-15,15);this.spawn(t,e+i,s+a)}update(t,e,s,i=0){const a=this.inventory;this.pickups=this.pickups.filter(n=>{if(a&&(a.canAdd(n.type,1)?n.enableAttract():n.disableAttract()),n.update(t,e,s,i))if(a){const{added:o}=a.add(n.type,1);o>0&&this.applyStats(n.type,o)}else this.applyStats(n.type,1);return n.isAlive})}applyStats(t,e){switch(t){case"coin":this.coins+=e;break;case"gem":this.gems+=e;break;case"wing":this.wings+=e;break}}clear(){for(const t of this.pickups)t.destroy();this.pickups=[]}reset(){this.clear(),this.coins=0,this.gems=0,this.wings=0}getStats(){return{coins:this.coins,gems:this.gems,wings:this.wings}}}class ut{scene;monsters=[];screenWidth;groundY;pixelsPerMeter;pickupManager=null;constructor(t,e,s,i){this.scene=t,this.screenWidth=e,this.groundY=s,this.pixelsPerMeter=i}setPickupManager(t){this.pickupManager=t}spawnInitialMonsters(){}update(t,e,s){const i=this.scene.time.now;for(const a of this.monsters)a.isAlive&&a.update(t,i,e,s)}checkDebuffCollision(t,e,s,i,a){const n=h.monster.a01.size/1.2,r=(s+n)*(s+n),o=30,l=o*o;for(const c of this.monsters){if(!c.isAlive||c.nextDebuffTime>i||c.noDebuffUntil>i||a?.recentKilledIds?.has?.(c.id)||a?.hasSwingGrace&&a.hasSwingGrace(i))continue;const f=c.x-t,p=c.y-e,d=f*f+p*p,g=c.isInChaseMode();if(d<(g?l:r)){const S=g;if(S){c.isAlive=!1,c.sprite.setTint(16777215);const u=c.sprite.x;this.scene.tweens.add({targets:c.sprite,x:u+10,duration:30,yoyo:!0,repeat:3}),this.scene.tweens.add({targets:c.sprite,scaleX:c.sprite.scaleX*2,scaleY:c.sprite.scaleY*2,alpha:0,duration:250,ease:"Quad.easeOut",onComplete:()=>{c.destroy()}})}else c.nextDebuffTime=i+300;return{type:c.type,isChaseHit:S}}}return null}checkSectorCollision(t,e,s,i,a){let n=0;const r=2,o=150,l=r*this.pixelsPerMeter;for(const c of this.monsters){if(!c.isAlive)continue;const f=c.x-e,p=30;if(!(t===-1?f>-o&&f<p:f>-p&&f<o))continue;if(Math.abs(c.y-s)<l){const y=c.x,S=c.y,u=c.type,x=a??this.scene.time.now;c.kill(),c.nextDebuffTime=Number.MAX_SAFE_INTEGER,c.noDebuffUntil=x+500;const M=i??this.scene.slime;M?.addDebuffGrace&&M.addDebuffGrace(300,x),M?.addRecentHitGrace&&M.addRecentHitGrace(200,x),M?.addRecentKill&&c.id!==void 0&&M.addRecentKill(c.id,x),n++,this.pickupManager&&this.pickupManager.spawnMonsterDrops(y,S,u),this.scene instanceof Z&&this.scene.bulletTimeManager?.onKill()}}return n}onPlayerLanded(){for(const t of this.monsters)t.isAlive?(t.scene.tweens.add({targets:t.sprite,alpha:0,duration:150,onComplete:()=>{t.destroy()}}),t.isAlive=!1):t.destroy();this.monsters=[]}respawnAboveMilestone(t){this.onPlayerLanded()}getAliveMonsters(){return this.monsters.filter(t=>t.isAlive)}getHighestAliveMonsterHeight(){const t=this.monsters.filter(e=>e.isAlive);return t.length===0?-1:Math.max(...t.map(e=>e.heightMeters))}getAliveMonsterCount(){return this.monsters.filter(t=>t.isAlive).length}spawnApexMonsters(t,e,s=1){const i=t/this.pixelsPerMeter;console.log(`[MonsterManager] ‚òÖ spawnApexMonsters Ë¢´Ë∞ÉÁî®! È´òÂ∫¶=${i.toFixed(0)}m, ÂÄçÁéá=${s}`);const a=h.monster.director,n=t/this.pixelsPerMeter,r=n*a.apexRangeStart,o=a.apexRangeEndBase,l=a.apexRangeEndMin,c=a.apexRangeEndTau,f=l+(o-l)*Math.exp(-n/c),p=n*f,d=a.baseCount,g=a.maxCount,y=a.refHeightM,S=a.countGrowthFactor;let u;if(n<=y)u=d;else{const b=Math.log2(n/y);u=Math.floor(d+b*S)}u=m.Math.Clamp(u,d,g),u=Math.max(1,Math.round(u*s));const x=a.speedRefHeightM,M=a.speedGrowthFactor,w=a.maxSpeedMultiplier;let T=1+n/x*M;T=Math.min(T,w),this.monsters=this.monsters.filter(b=>b.isAlive?b.heightMeters>=r-5&&b.heightMeters<=p+5?(b.destroy(),!1):!0:!1);const _=a.dynamicSpacing;let F=a.minSpacingMeters;{const b=_.baseSpacingM,H=_.heightRefM,L=_.heightFactor,P=_.heightMaxBonus,z=Math.min(n/H*L,P);F=b*(1+z)}if(p-r<F)return;const D=this.screenWidth/h.lane.count,Y=this.screenWidth/2,E=D*.2,k=a.difficultyCurve,A=_?.sameSideBonus,O=_?.diagonalBonus;let C=null,B=r;const I=b=>{if(!k||k.length<2)return .5;for(let H=0;H<k.length-1;H++){const[L,P]=k[H],[z,G]=k[H+1];if(b<=z){if(z===L)return P;const X=(b-L)/(z-L);return P+(G-P)*X}}return k[k.length-1][1]};let V=0;for(;V<u&&B<p;){let b;const H=I(B);if(C===null)b=m.Math.Between(0,2);else if(Math.random()<H){const U=[0,1,2].filter(K=>K!==C);b=U[Math.floor(Math.random()*U.length)]}else b=m.Math.Between(0,2);let L=F;C!==null&&(b===C?L=F*(1+A):Math.abs(b-C)===2&&(L=F*(1+O)));const P=B+L;if(P>p)break;C=b,B=P,V++;let z=m.Math.FloatBetween(-D*.15,D*.15),G=(b+.5)*D+z;if(b===1&&Math.abs(G-Y)<E){const U=Math.random()<.5?-1:1;G=Y+U*(E+D*.1)}const X=this.groundY-P*this.pixelsPerMeter,N=this.selectMonsterType(P),W=new $(this.scene,{type:N,x:m.Math.Clamp(G,30,this.screenWidth-30),y:X,heightMeters:P,speedMultiplier:T},this.screenWidth);this.monsters.push(W)}}selectMonsterType(t){let e=0;t<200?e=1:t<600&&(e=1-(t-200)/400);let s=0;if(t>=200&&t<600)s=(t-200)/400;else if(t>=600&&t<1e3){const l=(t-600)/400;s=Math.exp(-3*l)}let i=0;t>=600&&t<1e3?i=(t-600)/400:t>=1e3&&(i=1);let a=0;t>=400&&t<800?a=(t-400)/400:t>=800&&t<1100&&(a=1-(t-800)/300*.9);const n=[];if(e>.01&&n.push({type:"A01",weight:e}),s>.01&&n.push({type:"A02",weight:s}),i>.01&&n.push({type:"A03",weight:i}),a>.01&&n.push({type:"CloudA",weight:a}),n.length===0)return console.log(`[Monster] No candidates at ${t.toFixed(0)}m, defaulting to A03`),"A03";const r=n.reduce((l,c)=>l+c.weight,0);let o=Math.random()*r;for(const l of n)if(o-=l.weight,o<=0)return console.log(`[Monster] ${t.toFixed(0)}m ‚Üí ${l.type} (A01:${(e*100).toFixed(0)}% A02:${(s*100).toFixed(0)}% A03:${(i*100).toFixed(0)}% CloudA:${(a*100).toFixed(0)}%)`),l.type;return n[0].type}clear(){for(const t of this.monsters)t.destroy();this.monsters=[]}}class gt{scene;isActive=!1;timeScale=1;targetTimeScale=1;TRANSITION_SPEED=8;energy=0;energyCap=5;killRefundAccumulated=0;activeTimer=0;cooldownTimer=0;currentDuration=3;constructor(t){this.scene=t,this.energyCap=h.bulletTime.maxEnergyBase,this.currentDuration=h.bulletTime.baseDuration}update(t,e,s){if(this.cooldownTimer>0&&(this.cooldownTimer-=t),this.isActive){this.activeTimer+=t;let i=!1;this.activeTimer>=this.currentDuration?i=!0:s?e<=h.bulletTime.minActivationHeight&&(i=!0):i=!0,i&&this.deactivate()}if(Math.abs(this.timeScale-this.targetTimeScale)>.001){const i=1-Math.exp(-this.TRANSITION_SPEED*t);this.timeScale=this.timeScale+(this.targetTimeScale-this.timeScale)*i}else this.timeScale=this.targetTimeScale}activate(t,e){if(this.isActive||this.cooldownTimer>0||t<=h.bulletTime.minActivationHeight||!e)return!1;const s=h.bulletTime.costPerUse;return this.energy<s?!1:(this.energy-=s,this.isActive=!0,this.activeTimer=0,this.targetTimeScale=h.bulletTime.timeScaleMax,this.scene.events.emit("bullet-time-start"),!0)}deactivate(){this.isActive&&(this.isActive=!1,this.targetTimeScale=1,this.cooldownTimer=h.bulletTime.cooldown,this.scene.events.emit("bullet-time-end"))}forceActivate(){this.forceActivateWithHeight(50)}forceActivateWithHeight(t,e="PERFECT"){if(this.isActive)return;const s=h.bulletTime.baseDuration,i=h.bulletTime.maxExtraDuration,a=h.bulletTime.durationTau,n=i*(1-Math.exp(-t/a));let r=s+n;const o=h.bulletTime.timeScaleMax,l=h.bulletTime.timeScaleMin,c=h.bulletTime.timeScaleTau;let f=l+(o-l)*Math.exp(-t/c);e==="NORMAL"&&(r*=.55,f*=1.4,f=Math.min(f,.7)),this.currentDuration=r,this.isActive=!0,this.activeTimer=0,this.targetTimeScale=f,this.scene.events.emit("bullet-time-start")}addEnergy(t){this.energy+=t,this.energy>this.energyCap&&(this.energy=this.energyCap)}onKill(){if(!this.isActive)return;const t=h.bulletTime.energyPerKill;this.addEnergy(t);const e=h.bulletTime.killRefundCap,s=h.bulletTime.maxEnergyBase+Math.min(this.killRefundAccumulated+t,e),i=h.bulletTime.maxEnergyExtended;this.killRefundAccumulated<e&&(this.killRefundAccumulated+=t,this.energyCap=Math.min(s,i))}reset(){this.energy=12,this.energyCap=h.bulletTime.maxEnergyBase,this.killRefundAccumulated=0,this.isActive=!1,this.timeScale=1,this.cooldownTimer=0}getCooldownProgress(){return this.cooldownTimer<=0?0:this.cooldownTimer/h.bulletTime.cooldown}getTimeProgress(){return this.isActive?Math.min(1,this.activeTimer/this.currentDuration):0}getCurrentDuration(){return this.currentDuration}getActiveTimer(){return this.activeTimer}}class mt{scene;bulletTimeManager;container;icon;cooldownOverlay;borderRing;isVisible=!1;iconSize;isAccelerating=!1;acceleratedProgress=0;lastRealProgress=0;constructor(t,e){this.scene=t,this.bulletTimeManager=e,this.iconSize=h.ui.bulletTimeIcon?.size,this.container=t.add.container(0,0),this.container.setDepth(201),this.container.setVisible(!1),this.icon=t.add.image(0,0,"bt_icon"),this.icon.setDisplaySize(this.iconSize,this.iconSize),this.container.add(this.icon),this.cooldownOverlay=t.add.graphics(),this.container.add(this.cooldownOverlay),this.borderRing=t.add.graphics(),this.container.add(this.borderRing)}update(t,e){const s=this.bulletTimeManager.isActive;if(s&&!this.isVisible&&!this.isAccelerating?this.show():!s&&this.isVisible&&!this.isAccelerating&&this.startAcceleratedCompletion(),!this.isVisible)return;const i=h.ui.bulletTimeIcon?.yOffset;this.container.setPosition(t,e+i),this.updateCooldownOverlay()}startAcceleratedCompletion(){this.isAccelerating=!0,this.acceleratedProgress=this.lastRealProgress,this.scene.tweens.add({targets:this,acceleratedProgress:1,duration:200,ease:"Power2",onComplete:()=>{this.hide()}})}updateCooldownOverlay(){this.cooldownOverlay.clear(),this.borderRing.clear();let t;this.isAccelerating?t=this.acceleratedProgress:(t=this.bulletTimeManager.getTimeProgress(),this.lastRealProgress=t);const e=this.iconSize/2+4;if(this.borderRing.lineStyle(3,4491519,.9),this.borderRing.strokeCircle(0,0,e),t<=.001)return;const s=t*Math.PI*2,i=-Math.PI/2,a=i+s,n=this.iconSize/2+2,r=this.isAccelerating?.7:.55;this.cooldownOverlay.fillStyle(2254540,r),this.cooldownOverlay.beginPath(),this.cooldownOverlay.moveTo(0,0),this.cooldownOverlay.arc(0,0,n,i,a,!1),this.cooldownOverlay.closePath(),this.cooldownOverlay.fillPath();const o=Math.cos(a)*n,l=Math.sin(a)*n;this.cooldownOverlay.lineStyle(2,8965375,1),this.cooldownOverlay.beginPath(),this.cooldownOverlay.moveTo(0,0),this.cooldownOverlay.lineTo(o,l),this.cooldownOverlay.strokePath()}show(){this.isVisible=!0,this.isAccelerating=!1,this.acceleratedProgress=0,this.lastRealProgress=0,this.container.setVisible(!0),this.container.setAlpha(0),this.scene.tweens.add({targets:this.container,alpha:1,duration:150,ease:"Power2"})}hide(){this.scene.tweens.add({targets:this.container,alpha:0,duration:150,ease:"Power2",onComplete:()=>{this.isVisible=!1,this.isAccelerating=!1,this.container.setVisible(!1),this.cooldownOverlay.clear(),this.borderRing.clear()}})}destroy(){this.container.destroy()}}class yt{scene;inventory;container;panelBg=null;slots=[];icon;closeBtn;isOpen=!1;events=new m.Events.EventEmitter;textureCreated=!1;inputCooldownUntil=0;cols=4;rows=4;cropX=26;cropY=0;cropW=77;cropH=77;borderRatio=.026;bgScale=4;constructor(t,e){this.scene=t,this.inventory=e,this.container=t.add.container(0,0).setScrollFactor(0).setDepth(1200).setVisible(!1),this.createCroppedTexture(),t.textures.exists("inventory_4x4")&&(this.panelBg=t.add.image(0,0,"inventory_4x4").setOrigin(.5,.5),this.panelBg.setScale(this.bgScale),this.panelBg.setInteractive(),this.panelBg.on("pointerdown",()=>{}),this.container.add(this.panelBg)),this.closeBtn=this.createCloseButton(),this.closeBtn.setScrollFactor(0).setDepth(1201).setVisible(!1),this.createGrid(),this.icon=t.add.image(0,0,"backpack_icon").setScrollFactor(0).setDepth(1100).setInteractive({useHandCursor:!0}),this.icon.setDisplaySize(72,72),this.icon.on("pointerdown",()=>{this.isOpen||this.show()}),this.layout(),t.scale.on("resize",this.layout,this)}createCloseButton(){const e=this.scene.add.container(0,0),s=this.scene.add.graphics();s.fillStyle(0,.9),s.fillRoundedRect(-50/2,-50/2,50,50,10),s.lineStyle(3,16777215,.8),s.strokeRoundedRect(-50/2,-50/2,50,50,10),e.add(s);const i=this.scene.add.text(0,0,"‚úï",{fontFamily:"Arial",fontSize:"32px",fontStyle:"bold",color:"#ffffff"}).setOrigin(.5,.5);return e.add(i),e.setSize(50,50),e.setInteractive({useHandCursor:!0,hitArea:new m.Geom.Rectangle(-50/2,-50/2,50,50),hitAreaCallback:m.Geom.Rectangle.Contains}),e.on("pointerdown",()=>{this.hide()}),e.on("pointerover",()=>{i.setColor("#ff6666"),s.clear(),s.fillStyle(3355443,.95),s.fillRoundedRect(-50/2,-50/2,50,50,10),s.lineStyle(3,16737894,1),s.strokeRoundedRect(-50/2,-50/2,50,50,10)}),e.on("pointerout",()=>{i.setColor("#ffffff"),s.clear(),s.fillStyle(0,.9),s.fillRoundedRect(-50/2,-50/2,50,50,10),s.lineStyle(3,16777215,.8),s.strokeRoundedRect(-50/2,-50/2,50,50,10)}),e}createCroppedTexture(){if(this.textureCreated||!this.scene.textures.exists("inventory_bg"))return;if(this.scene.textures.exists("inventory_4x4")){this.textureCreated=!0;return}const t=this.scene.add.renderTexture(0,0,this.cropW,this.cropH);t.draw("inventory_bg",-this.cropX,-this.cropY),t.saveTexture("inventory_4x4"),t.destroy(),this.textureCreated=!0}toggle(){this.isOpen?this.hide():this.show()}show(){this.isOpen||(this.isOpen=!0,this.layout(),this.refreshSlots(),this.container.setVisible(!0),this.container.setAlpha(1),this.closeBtn.setVisible(!0),this.events.emit("open"))}hide(){this.isOpen&&(this.isOpen=!1,this.container.setVisible(!1),this.closeBtn.setVisible(!1),this.inputCooldownUntil=this.scene.time.now+100,this.events.emit("close"))}isInCooldown(){return this.scene.time.now<this.inputCooldownUntil}isShown(){return this.isOpen}layout=()=>{const t=this.scene.scale.width,e=this.scene.scale.height;this.icon.setPosition(t-16-this.icon.displayWidth*.5,e-16-this.icon.displayHeight*.5),this.container.setPosition(t/2,e/2);const s=this.cropW*this.bgScale,i=this.cropH*this.bgScale,a=t/2+s/2+25,n=e/2-i/2-25;this.closeBtn.setPosition(a,n);const r=s/this.cols,o=i/this.rows,l=s*this.borderRatio;let c=0;for(let f=0;f<this.rows;f++)for(let p=0;p<this.cols;p++)if(c<this.slots.length){const d=this.slots[c],g=-s/2+l+p*r+r/2,y=-i/2+l+f*o+o/2;d.setPosition(g,y);const S=d.getByName("icon");S&&S.setDisplaySize(r*.6,o*.6);const u=d.getByName("lockOverlay");u&&!this.inventory.isSlotUnlocked(c)&&(u.clear(),u.fillStyle(0,.6),u.fillRoundedRect(-r/2+4,-o/2+4,r-8,o-8,4)),c++}};refreshSlots(){const t=this.inventory.getSlots();for(let e=0;e<this.slots.length;e++){const s=this.slots[e],i=t[e],a=s.getByName("icon"),n=s.getByName("count");i&&i.type&&i.count>0?(a.setTexture(this.getIconKey(i.type)),a.setVisible(!0),n.setText(i.count>1?String(i.count):""),n.setVisible(i.count>1)):(a.setVisible(!1),n.setVisible(!1))}}createGrid(){for(let t=0;t<this.cols*this.rows;t++){const e=!this.inventory.isSlotUnlocked(t),s=this.scene.add.image(0,0,"pickup_coin");s.setVisible(!1),s.setName("icon");const i=this.scene.add.text(0,0,"",{fontSize:"20px",fontFamily:"Arial",fontStyle:"bold",color:"#ffffff",stroke:"#000000",strokeThickness:3}).setOrigin(.5,.5).setName("count"),a=this.scene.add.graphics();a.setName("lockOverlay"),a.setVisible(e);const n=this.scene.add.text(0,0,"üîí",{fontSize:"28px"}).setOrigin(.5,.5).setName("lockIcon");n.setVisible(e);const r=this.scene.add.container(0,0,[s,i,a,n]);this.container.add(r),this.slots.push(r)}}getIconKey(t){switch(t){case"coin":return"pickup_coin";case"gem":return"pickup_gem";case"wing":return"pickup_wing";default:return"pickup_coin"}}onOpen(t){this.events.on("open",t)}onClose(t){this.events.on("close",t)}}class Z extends m.Scene{slime;ground;isSpaceDown=!1;pointerDownCount=0;gameStarted=!1;gestureManager;shakeRig;isCameraTransitioning=!1;cameraTransitionStartTime=0;accumulator=0;FIXED_DT=1/120;MAX_FRAME_DT=.25;MAX_STEPS_PER_FRAME=8;heightText;startOverlay;recordHeight=0;milestoneGraphics;milestoneText;pixelsPerMeter=50;debuffTexts=[];inventoryManager;backpackUI;isPausedForBackpack=!1;backpackKey;skyGradient;safeFrame;gameOverOverlay;isGameOver=!1;isPlayingDeathAnimation=!1;isTestMode=!1;monsterManager;bulletTimeManager;bulletTimeHourglass;pickupManager;constructor(){super("GameScene")}preload(){this.load.spritesheet("cyclop","assets/sprites/CyclopJump.png",{frameWidth:32,frameHeight:32}),this.load.image("ground_block","assets/tiles/ground_block.png"),this.load.image("Ê∏êÂèòËâ≤Ë∞ÉÂõæ","assets/lut/Ê∏êÂèòËâ≤Ë∞ÉÂõæ.png");for(let t=1;t<=12;t++){const e=String(t).padStart(4,"0");this.load.image(`die_${t}`,`assets/DIE STATE/HumanSoulDie_${e}.png`)}for(let t=1;t<=8;t++){const e=String(t).padStart(4,"0");this.load.image(`idle_${t}`,`assets/HumanIdle State/HumanIdle_${e}.png`)}for(let t=0;t<8;t++){const e=String(t).padStart(2,"0");this.load.image(`idle_left_${t+1}`,`assets/HumanIdle State Left/HumanIdle_row2_${e}.png`)}for(let t=1;t<=4;t++){const e=String(t).padStart(4,"0");this.load.image(`jump_${t}`,`assets/Jump State/Jump_${e}.png`)}for(let t=1;t<=4;t++){const e=String(t).padStart(4,"0");this.load.image(`jump_left_${t}`,`assets/Jump State Left/Jump_Left_${e}.png`)}for(let t=1;t<=4;t++)this.load.image(`attack_right_${t}`,`assets/Human Attack State/RIGHT/frame_${t}.png`);for(let t=1;t<=4;t++)this.load.image(`attack_left_${t}`,`assets/Human Attack State/LEFT/frame_${t}.png`);for(let t=1;t<=3;t++)this.load.image(`monster_a01_left_${t}`,`assets/Monsters/Monster A01/left_frame_${t}.png`),this.load.image(`monster_a01_right_${t}`,`assets/Monsters/Monster A01/right_frame_${t}.png`);for(let t=1;t<=3;t++){const e=String(t).padStart(2,"0");this.load.image(`monster_a02_left_${t}`,`assets/Monsters/Monster A02/BatD_left_frame_${e}.png`),this.load.image(`monster_a02_right_${t}`,`assets/Monsters/Monster A02/BatD_right_frame_${e}.png`)}for(let t=1;t<=3;t++){const e=String(t).padStart(2,"0");this.load.image(`monster_a03_left_${t}`,`assets/Monsters/Monster A03/BatH_left_${e}.png`),this.load.image(`monster_a03_right_${t}`,`assets/Monsters/Monster A03/BatH_right_${e}.png`)}for(let t=1;t<=4;t++){const e=String(t).padStart(2,"0");this.load.image(`monster_clouda_left_${t}`,`assets/Monsters/Monster CloudA/LEFT/CloudA_frame_${e}.png`)}this.load.image("monster_clouda_middle","assets/Monsters/Monster CloudA/MIDDLE/CloudA_frame_05.png");for(let t=6;t<=9;t++){const e=String(t).padStart(2,"0"),s=t-5;this.load.image(`monster_clouda_right_${s}`,`assets/Monsters/Monster CloudA/RIGHT/CloudA_frame_${e}.png`)}this.load.image("backpack_icon","assets/ui/Backpack.png"),this.load.image("inventory_bg","assets/ui/Inventory.png"),this.load.image("bt_icon","assets/ui/bt_icon.png");for(let t=1;t<=11;t++)this.load.image(`chargeup_${t}`,`assets/effects/ChargingUp Animation/ChargingUp_frame_${String(t).padStart(2,"0")}.png`);this.load.image("pickup_coin","assets/drops/CoinsCopper0.png"),this.load.image("pickup_gem","assets/drops/A01_Wing.png"),this.load.image("pickup_wing","assets/drops/A02_Wing.png")}create(){const{width:t,height:e}=this.scale,s=e*.8;this.cameras.main.fadeIn(300,0,0,0),this.isGameOver=!1,this.isPlayingDeathAnimation=!1,this.gameStarted=!1,this.isSpaceDown=!1,this.pointerDownCount=0,this.recordHeight=0,this.accumulator=0,this.isCameraTransitioning=!1,this.bulletTimeManager=new gt(this),this.bulletTimeManager.reset(),this.bulletTimeHourglass=new mt(this,this.bulletTimeManager),this.events.on("bullet-time-start",()=>{}),this.events.on("bullet-time-end",()=>{}),this.skyGradient=new ht(this,"Ê∏êÂèòËâ≤Ë∞ÉÂõæ",s),this.anims.create({key:"idle",frames:[{key:"idle_1"},{key:"idle_2"},{key:"idle_3"},{key:"idle_4"},{key:"idle_5"},{key:"idle_6"},{key:"idle_7"},{key:"idle_8"}],frameRate:8,repeat:-1}),this.anims.create({key:"idle_left",frames:[{key:"idle_left_1"},{key:"idle_left_2"},{key:"idle_left_3"},{key:"idle_left_4"},{key:"idle_left_5"},{key:"idle_left_6"},{key:"idle_left_7"},{key:"idle_left_8"}],frameRate:8,repeat:-1}),this.anims.create({key:"jump_rise",frames:[{key:"jump_1"},{key:"jump_2"}],frameRate:12,repeat:0}),this.anims.create({key:"jump_fall",frames:[{key:"jump_3"},{key:"jump_4"}],frameRate:12,repeat:0}),this.anims.create({key:"jump_rise_left",frames:[{key:"jump_left_1"},{key:"jump_left_2"}],frameRate:12,repeat:0}),this.anims.create({key:"jump_fall_left",frames:[{key:"jump_left_3"},{key:"jump_left_4"}],frameRate:12,repeat:0}),this.anims.create({key:"jump_land",frames:[{key:"jump_4"}],frameRate:1,repeat:0}),this.anims.create({key:"jump_land_left",frames:[{key:"jump_left_4"}],frameRate:1,repeat:0}),this.anims.create({key:"attack_right",frames:[{key:"attack_right_1"},{key:"attack_right_2"},{key:"attack_right_3"},{key:"attack_right_4"}],frameRate:24,repeat:0}),this.anims.create({key:"attack_left",frames:[{key:"attack_left_1"},{key:"attack_left_2"},{key:"attack_left_3"},{key:"attack_left_4"}],frameRate:24,repeat:0}),this.anims.create({key:"jump",frames:[{key:"jump_1"},{key:"jump_2"},{key:"jump_3"},{key:"jump_4"}],frameRate:10,repeat:-1}),this.anims.create({key:"die",frames:[{key:"die_1"},{key:"die_2"},{key:"die_3"},{key:"die_4"},{key:"die_5"},{key:"die_6"},{key:"die_7"},{key:"die_8"},{key:"die_9"},{key:"die_10"},{key:"die_11"},{key:"die_12"}],frameRate:12,repeat:0}),this.anims.create({key:"monster_a01_left",frames:[{key:"monster_a01_left_1"},{key:"monster_a01_left_2"},{key:"monster_a01_left_3"}],frameRate:h.monster.a01.frameRate,repeat:-1}),this.anims.create({key:"monster_a01_right",frames:[{key:"monster_a01_right_1"},{key:"monster_a01_right_2"},{key:"monster_a01_right_3"}],frameRate:h.monster.a01.frameRate,repeat:-1}),this.anims.create({key:"monster_a02_left",frames:[{key:"monster_a02_left_1"},{key:"monster_a02_left_2"},{key:"monster_a02_left_3"}],frameRate:h.monster.a02.frameRate,repeat:-1}),this.anims.create({key:"monster_a02_right",frames:[{key:"monster_a02_right_1"},{key:"monster_a02_right_2"},{key:"monster_a02_right_3"}],frameRate:h.monster.a02.frameRate,repeat:-1}),this.textures.exists("monster_a03_left_1")?(this.anims.create({key:"monster_a03_left",frames:[{key:"monster_a03_left_1"},{key:"monster_a03_left_2"},{key:"monster_a03_left_3"}],frameRate:h.monster.a03?.frameRate,repeat:-1}),this.anims.create({key:"monster_a03_right",frames:[{key:"monster_a03_right_1"},{key:"monster_a03_right_2"},{key:"monster_a03_right_3"}],frameRate:h.monster.a03?.frameRate,repeat:-1})):(console.warn("[GameScene] A03 textures not found, using A01 as fallback"),this.anims.create({key:"monster_a03_left",frames:[{key:"monster_a01_left_1"},{key:"monster_a01_left_2"},{key:"monster_a01_left_3"}],frameRate:8,repeat:-1}),this.anims.create({key:"monster_a03_right",frames:[{key:"monster_a01_right_1"},{key:"monster_a01_right_2"},{key:"monster_a01_right_3"}],frameRate:8,repeat:-1})),this.textures.exists("monster_clouda_left_1")&&(this.anims.create({key:"monster_clouda_left",frames:[{key:"monster_clouda_left_1"},{key:"monster_clouda_left_2"},{key:"monster_clouda_left_3"},{key:"monster_clouda_left_4"}],frameRate:h.monster.cloudA?.frameRate,repeat:-1}),this.anims.create({key:"monster_clouda_right",frames:[{key:"monster_clouda_right_1"},{key:"monster_clouda_right_2"},{key:"monster_clouda_right_3"},{key:"monster_clouda_right_4"}],frameRate:h.monster.cloudA?.frameRate,repeat:-1})),this.ground=new nt(this,s);const i=h.display.playerCollisionRadius;this.slime=new rt(this,t/2,this.ground.y-i,this.ground),this.slime.setScreenWidth(t),this.gestureManager=new lt(t),this.pickupManager=new pt(this),this.inventoryManager=new dt,this.pickupManager.setInventoryManager(this.inventoryManager),this.inventoryManager.setPickupManager(this.pickupManager),this.monsterManager=new ut(this,t,s,this.pixelsPerMeter),this.monsterManager.setPickupManager(this.pickupManager),this.monsterManager.spawnInitialMonsters(),this.input.keyboard?.on("keydown-SPACE",()=>{this.isSpaceDown=!0}),this.input.keyboard?.on("keyup-SPACE",()=>{this.isSpaceDown=!1}),this.input.keyboard?.on("keydown-A",()=>{this.slime.state==="AIRBORNE"&&!this.slime.laneSwitchLocked&&this.slime.requestLaneChange(-1,(c,f,p)=>{this.monsterManager.checkSectorCollision(c,f,p,this.slime,this.time.now)})}),this.input.keyboard?.on("keydown-D",()=>{this.slime.state==="AIRBORNE"&&!this.slime.laneSwitchLocked&&this.slime.requestLaneChange(1,(c,f,p)=>{this.monsterManager.checkSectorCollision(c,f,p,this.slime,this.time.now)})}),this.backpackKey=this.input.keyboard?.addKey(m.Input.Keyboard.KeyCodes.B),this.input.on("pointerdown",c=>{this.shouldBlockGameInput()||(this.pointerDownCount++,this.gestureManager.onPointerDown(c.id,c.x,c.y,this.time.now))}),this.input.on("pointermove",c=>{this.shouldBlockGameInput()||this.gestureManager.onPointerMove(c.id,c.x,c.y)}),this.input.on("pointerup",c=>{this.shouldBlockGameInput()||(this.pointerDownCount--,this.gestureManager.onPointerUp(c.id),this.pointerDownCount<=0&&(this.pointerDownCount=0))}),this.input.on("pointerupoutside",c=>{this.shouldBlockGameInput()||(this.pointerDownCount--,this.gestureManager.onPointerUp(c.id),this.pointerDownCount<=0&&(this.pointerDownCount=0))}),this.input.on("pointercancel",()=>{this.shouldBlockGameInput()||(this.pointerDownCount=0,this.gestureManager.clearAll())}),this.game.events.on("blur",()=>{this.pointerDownCount=0,this.isSpaceDown=!1,this.gestureManager.clearAll()}),this.game.events.on("hidden",()=>{this.pointerDownCount=0,this.isSpaceDown=!1,this.gestureManager.clearAll()});const a=Math.min(h.ui.heightText.maxFontSize,Math.floor(t*h.ui.heightText.fontSizePercent)),r=e*.8+h.ui.heightText.yOffset;this.heightText=this.add.text(t/2,r,"0m",{fontSize:`${a}px`,fontFamily:"Arial",color:"#ffffff",align:"center",fontStyle:"bold",stroke:"#000000",strokeThickness:Math.max(3,a*.1)}).setOrigin(.5,0).setDepth(200).setVisible(!1),this.debuffTexts=[0,1,2].map(()=>this.add.text(0,0,"",{fontSize:"24px",fontFamily:"Arial",fontStyle:"bold",color:"#ffcc00",stroke:"#000000",strokeThickness:4}).setOrigin(.5).setDepth(201).setVisible(!1)),this.milestoneGraphics=this.add.graphics();const o=Math.min(32,Math.floor(t*.05));this.milestoneText=this.add.text(0,0,"",{fontSize:`${o}px`,color:"#ffff00",fontStyle:"bold",stroke:"#000000",strokeThickness:4}).setDepth(50),this.backpackUI=new yt(this,this.inventoryManager),this.backpackUI.onOpen(()=>this.pauseForBackpack()),this.backpackUI.onClose(()=>this.resumeFromBackpack()),this.createStartScreen(t,e),this.shakeRig=new ot;const l=h.display.zoom;this.cameras.main.setZoom(l),this.scale.on("resize",this.applyResponsiveLayout,this),this.applyResponsiveLayout()}computeSafeFrame(){const t=this.scale.width,e=this.scale.height,s=9/16,i=t/e;let a,n,r,o;i>s?(n=e,a=e*s,r=(t-a)/2,o=0):(a=t,n=t/s,r=0,o=(e-n)/2),this.safeFrame={x:r,y:o,width:a,height:n}}applyResponsiveLayout(){this.computeSafeFrame();const t=this.safeFrame,e=this.scale.width,s=this.scale.height;if(this.heightText){const i=Math.min(h.ui.heightText.maxFontSize,Math.floor(t.width*h.ui.heightText.fontSizePercent));this.heightText.setFontSize(i),this.heightText.setStroke("#000000",Math.max(4,i*.1))}if(this.startOverlay&&this.startOverlay.active){const i=this.startOverlay.getAt(0);i&&i instanceof m.GameObjects.Rectangle&&(i.setPosition(e/2,s/2),i.setSize(e,s))}if(this.milestoneText){const i=Math.min(32,Math.floor(t.width*.05));this.milestoneText.setFontSize(i)}this.slime&&this.slime.applyUIScale(t.width)}createStartScreen(t,e){const s=this.add.rectangle(t/2,e/2,t,e,657941,.85).setScrollFactor(0),i=this.add.graphics().setScrollFactor(0),a=40;i.lineStyle(4,4864040,1),i.strokeRect(a,a,t-a*2,e-a*2),i.lineStyle(2,8149562,.6),i.strokeRect(a+6,a+6,t-a*2-12,e-a*2-12);const n=this.add.graphics().setScrollFactor(0);n.fillStyle(4007959,1),n.fillRect(60,80,t-120,8),n.fillStyle(6045747,1),n.fillRect(60,82,t-120,3);const r=this.add.text(t/2+4,e*.18+4,"CRAZY JUMPY",{fontFamily:'"Press Start 2P", "Courier New", monospace',fontSize:"32px",color:"#1a2e12"}).setOrigin(.5).setScrollFactor(0),o=this.add.text(t/2,e*.18,"CRAZY JUMPY",{fontFamily:'"Press Start 2P", "Courier New", monospace',fontSize:"32px",color:"#7cba5f",stroke:"#2d4a1c",strokeThickness:4}).setOrigin(.5).setScrollFactor(0);this.tweens.add({targets:[o,r],scaleX:1.03,scaleY:1.03,duration:1200,yoyo:!0,repeat:-1,ease:"Sine.easeInOut"});const l=this.add.graphics().setScrollFactor(0);l.fillStyle(1710638,.9),l.fillRoundedRect(t/2-200,e*.28,400,160,12),l.lineStyle(2,4868714,.8),l.strokeRoundedRect(t/2-200,e*.28,400,160,12);const c=this.add.text(t/2,e*.32,"‚óÜ Êìç‰ΩúÊåáÂçó ‚óÜ",{fontFamily:'"Microsoft YaHei", sans-serif',fontSize:"18px",color:"#8fd464",fontStyle:"bold"}).setOrigin(.5).setScrollFactor(0),f=this.add.text(t/2,e*.42,`Êåâ‰ΩèÂ±èÂπï/SPACE ‚Üí Âø´ÈÄü‰∏ãËêΩ
ÈªÑËâ≤Èó™ÁÉÅÊó∂ÊùæÂºÄ ‚Üí PERFECT
ËøûÁª≠3Ê¨°PERFECT ‚Üí 2ÂÄçÂäõÈáè!`,{fontFamily:'"Microsoft YaHei", sans-serif',fontSize:"16px",color:"#cccccc",align:"center",lineSpacing:12}).setOrigin(.5).setScrollFactor(0),p=this.createPixelButton(t/2,e*.58,260,60,"‚ñ∂  ÂºÄÂßãÊ∏∏Êàè",()=>this.startGame(!1)),d=this.createPixelButton(t/2,e*.68,260,50,"‚öô  ÊµãËØïÊ®°Âºè",()=>this.startGame(!0),!0),g=this.add.text(t/2,e*.76,"ÊµãËØïÊ®°ÂºèÔºöÊó†ÈôêË°Ä / ÂàùÂßã100m",{fontFamily:'"Microsoft YaHei", sans-serif',fontSize:"12px",color:"#6a6a8a"}).setOrigin(.5).setScrollFactor(0),y=this.add.graphics().setScrollFactor(0);y.fillStyle(4007959,1),y.fillRect(60,e-88,t-120,8),y.fillStyle(6045747,1),y.fillRect(60,e-86,t-120,3),this.input.keyboard?.once("keydown-SPACE",()=>{this.gameStarted||this.startGame(!1)}),this.startOverlay=this.add.container(0,0,[s,i,n,y,r,o,l,c,f,p,d,g]),this.startOverlay.setDepth(1e3),this.startOverlay.setAlpha(0),this.tweens.add({targets:this.startOverlay,alpha:1,duration:400,ease:"Quad.easeOut"})}createPixelButton(t,e,s,i,a,n,r=!1){const o=this.add.container(t,e).setScrollFactor(0),l=this.add.graphics();l.fillStyle(1707781,.7),l.fillRoundedRect(-s/2+4,-i/2+4,s,i,8),o.add(l);const c=this.add.graphics(),f=r?4868714:9132587,p=r?6974090:10910802,d=r?2763338:7029795,g=r?3816026:4862489,y=r?8026778:12883306;c.fillStyle(f,1),c.fillRoundedRect(-s/2,-i/2,s,i,8),c.fillStyle(p,1),c.fillRoundedRect(-s/2+4,-i/2+4,s-8,i/3,6),c.fillStyle(d,1),c.fillRoundedRect(-s/2+4,i/6,s-8,i/3,6),c.lineStyle(3,g,1),c.strokeRoundedRect(-s/2,-i/2,s,i,8),c.lineStyle(1,y,.4),c.strokeRoundedRect(-s/2+3,-i/2+3,s-6,i-6,6),o.add(c);const S=(w,T)=>{const _=this.add.graphics();_.fillStyle(2759178,.5),_.fillCircle(w+1,T+1,5),_.fillStyle(r?5921402:6045747,1),_.fillCircle(w,T,5),_.fillStyle(r?9079466:9139029,1),_.fillCircle(w-1.5,T-1.5,2),o.add(_)};S(-s/2+14,0),S(s/2-14,0);const u=r?"#aaaacc":"#3d2817",x=this.add.text(0,0,a,{fontFamily:'"Microsoft YaHei", sans-serif',fontSize:r?"16px":"20px",fontStyle:"bold",color:u}).setOrigin(.5);o.add(x);const M=this.add.rectangle(0,0,s,i,16777215,0);return M.setInteractive({useHandCursor:!0}),o.add(M),M.on("pointerover",()=>{this.tweens.add({targets:o,scaleX:1.05,scaleY:1.05,duration:80,ease:"Quad.easeOut"}),x.setColor(r?"#ffffff":"#1a0f05")}),M.on("pointerout",()=>{this.tweens.add({targets:o,scaleX:1,scaleY:1,duration:80,ease:"Quad.easeOut"}),x.setColor(u)}),M.on("pointerdown",()=>{n(),this.tweens.add({targets:o,scaleX:.95,scaleY:.95,duration:50,yoyo:!0,ease:"Quad.easeInOut"})}),o}startGame(t=!1){this.isTestMode=t,this.gameStarted=!0,this.startOverlay.destroy(),this.isPausedForBackpack=!1,this.backpackUI.hide(),this.heightText.setVisible(!0),this.isSpaceDown=!1,this.pointerDownCount=0,this.isCameraTransitioning=!0,this.cameraTransitionStartTime=this.time.now,this.slime&&this.slime.healthManager&&this.slime.healthManager.setInvincible(this.isTestMode);const e=100*this.pixelsPerMeter;this.slime.lastApexHeight=e,this.slime.landingApexHeight=e,this.slime.landingFallDistance=e,this.slime.landingFastFallDistance=e,this.slime.pendingTestJumpHeightPx=e,this.recordHeight=Math.max(this.recordHeight,e),this.inventoryManager.clear(),this.pickupManager.reset()}shouldBlockGameInput(){return!!(this.isPausedForBackpack||this.backpackUI&&this.backpackUI.isInCooldown())}pauseForBackpack(){this.isPausedForBackpack||(this.isPausedForBackpack=!0,this.isSpaceDown=!1,this.pointerDownCount=0,this.gestureManager.clearAll())}resumeFromBackpack(){this.isPausedForBackpack&&(this.isPausedForBackpack=!1,this.isSpaceDown=!1,this.pointerDownCount=0,this.gestureManager.clearAll())}toggleBackpack(){this.backpackUI.isShown()?(this.backpackUI.hide(),this.resumeFromBackpack()):(this.backpackUI.show(),this.pauseForBackpack())}update(t,e){if(!this.gameStarted)return;if(m.Input.Keyboard.JustDown(this.backpackKey)&&this.toggleBackpack(),this.isPausedForBackpack){this.backpackUI.refreshSlots();return}if(this.isGameOver){const k=e/1e3;this.pickupManager.update(k,this.slime.x,this.slime.y,0);return}if(this.isPlayingDeathAnimation){const k=e/1e3;this.ground.render(k,0,this.slime.x);const A=this.ground.getSurfaceOffsetAt(this.slime.x),O=h.display.corpseYOffset,C=this.ground.y-this.slime.radius+O,B=this.ground.y+A-this.slime.radius+O,I=Math.max(C,B);this.slime.y=I,this.slime.graphics.setPosition(this.slime.x,I),this.skyGradient.update(this.slime.y),this.pickupManager.update(k,this.slime.x,this.slime.y,0);return}const s=e/1e3,i=Math.min(s,this.MAX_FRAME_DT),a=(this.ground.y-this.slime.y)/this.pixelsPerMeter,n=this.slime.vy<0;this.bulletTimeManager.update(i,a,n),this.bulletTimeManager.update(i,a,n),this.accumulator+=i;const r=this.time.now;this.slime.state==="AIRBORNE"&&this.slime.vy<0&&(this.slime.resetLaneSwitchLock(),this.gestureManager.resetLaneSwitchLock());const o=this.gestureManager.update(r),l=o.isHoldActive||this.isSpaceDown;if(this.slime.state==="AIRBORNE"&&this.slime.vy<0&&o.swipeDirection!==0){const k=o.swipeDirection;this.slime.requestLaneChange(k,(A,O,C)=>{this.monsterManager.checkSectorCollision(A,O,C,this.slime,this.time.now)})}let c=0;const f=this.bulletTimeManager.timeScale;for(;this.accumulator>=this.FIXED_DT&&c<this.MAX_STEPS_PER_FRAME;){const k=this.FIXED_DT*f;this.slime.update(k*1e3,l),this.ground.render(k,this.slime.getCompression(),this.slime.x),this.monsterManager.update(k,this.slime.x,this.slime.y);const A=Math.abs(this.slime.vy);if(this.pickupManager.update(k,this.slime.x,this.slime.y,A),this.slime.state==="AIRBORNE"&&!this.slime.hasDebuffGrace(this.time.now)&&!this.slime.hasRecentHitGrace(this.time.now)&&!this.slime.hasRecentHitWindow(this.time.now)&&!this.slime.hasSwingGrace(this.time.now)){const O=this.monsterManager.checkDebuffCollision(this.slime.x,this.slime.y,this.slime.radius,this.time.now,this.slime);if(O){const C=O.isChaseHit?2:1;this.slime.applyDebuffFromMonster(O.type,C)}}this.accumulator-=this.FIXED_DT,c++}c>=this.MAX_STEPS_PER_FRAME&&(this.accumulator=0);const p=this.scale.height,d=e/1e3,g=p*.75,y=this.slime.y-g,S=this.cameras.main.scrollY;let u=S;if(this.isCameraTransitioning){const A=(this.time.now-this.cameraTransitionStartTime)/2e3;if(A>=1)this.isCameraTransitioning=!1,u=y;else{const O=1-Math.pow(1-A,3),C=0;u=C+(y-C)*O}}else{const A=Math.max(3e3,Math.abs(this.slime.vy)+1500)*d;u=S+m.Math.Clamp(y-S,-A,A)}const x=this.bulletTimeManager.isActive,M=x?0:this.slime.chargeShake01,w=x?0:this.slime.airShake01;this.shakeRig.update(d,M,w),this.cameras.main.scrollY=u+this.shakeRig.shakeY,this.cameras.main.scrollX=this.shakeRig.shakeX;const T=this.ground.y,_=this.slime.y+this.slime.radius,R=Math.max(0,T-_)/this.pixelsPerMeter;this.heightText.setText(`${R.toFixed(0)}m`);const D=h.ui.heightText.yOffset;this.heightText.setPosition(this.slime.x,this.slime.y+D),this.bulletTimeHourglass.update(this.slime.x,this.slime.y),this.updateDebuffUI(),this.skyGradient.update(this.slime.y);const Y=this.slime.y-this.slime.radius,E=Math.max(0,T-Y);if(this.updateMilestone(T,E),this.slime.healthManager.isDead&&!this.isGameOver&&!this.isPlayingDeathAnimation){this.isPlayingDeathAnimation=!0;const k=this.ground.y,A=this.inventoryManager.dropAll(this,this.slime.x,this.slime.y,k);this.slime.playDeathAnimation(()=>{const C=Math.max(0,A-1200);C>0?this.time.delayedCall(C,()=>{this.showGameOver()}):this.showGameOver()})}}updateMilestone(t,e){const i=this.cameras.main.scrollX;e>this.recordHeight&&(this.recordHeight=e),this.milestoneGraphics.clear();const a=h.milestone?.yOffset,n=t-this.recordHeight+a;this.milestoneGraphics.lineStyle(2,16776960,.8),this.milestoneGraphics.beginPath(),this.milestoneGraphics.moveTo(i-5e3,n),this.milestoneGraphics.lineTo(i+15e3,n),this.milestoneGraphics.strokePath();const r=i+10,o=this.recordHeight/this.pixelsPerMeter;this.milestoneText.setText(`üèÜ ${o.toFixed(0)}m`),this.milestoneText.setPosition(r,n-25)}updateDebuffUI(){if(!this.debuffTexts?.length)return;const t=[];if(this.slime.poison1Duration>0&&t.push({label:`ÊØíI ${this.slime.poison1Duration.toFixed(1)}s`,color:"#55ff55"}),this.slime.poison2Duration>0&&t.push({label:`ÊØíII ${this.slime.poison2Duration.toFixed(1)}s`,color:"#00ffff"}),this.slime.slowImpulseTimer>0&&t.push({label:"ÂáèÈÄü",color:"#ffcc00"}),t.length===0){this.debuffTexts.forEach(r=>r.setVisible(!1));return}const s=(this.slime.y+(this.heightText.y+this.heightText.height*this.heightText.scaleY*.5))/2+10,i=this.slime.x,a=[[0],[-40,40],[-60,0,60]];this.debuffTexts.forEach(r=>r.setVisible(!1));const n=a[Math.min(t.length,3)-1]??[];t.slice(0,3).forEach((r,o)=>{const l=this.debuffTexts[o];l.setText(r.label),l.setColor(r.color),l.setPosition(i+n[o],s),l.setVisible(!0)})}onPlayerLanded(){this.monsterManager.onPlayerLanded()}showGameOver(){this.isGameOver=!0;const t=this.scale.width,e=this.scale.height,s=this.add.rectangle(t/2,e/2,t,e,0,.8).setScrollFactor(0).setDepth(2e3),i=this.add.text(t/2,e*.3,"üíÄ Ê∏∏ÊàèÁªìÊùü üíÄ",{fontSize:"72px",fontFamily:"Arial",fontStyle:"bold",color:"#ff0000",stroke:"#000000",strokeThickness:8}).setOrigin(.5).setScrollFactor(0).setDepth(2001),a=this.recordHeight/this.pixelsPerMeter,n=this.add.text(t/2,e*.5,`ÊúÄÈ´òËÆ∞ÂΩï: ${a.toFixed(0)}m
ÁîüÂëΩÂÄº: 0`,{fontSize:"32px",fontFamily:"Arial",color:"#ffffff",align:"center",lineSpacing:10}).setOrigin(.5).setScrollFactor(0).setDepth(2001),r=this.add.text(t/2,e*.65,"[ ÈáçÊñ∞ÂºÄÂßã ]",{fontSize:"42px",fontFamily:"Arial",fontStyle:"bold",color:"#00ff00",stroke:"#000000",strokeThickness:6}).setOrigin(.5).setScrollFactor(0).setDepth(2001).setInteractive({useHandCursor:!0});r.on("pointerover",()=>{r.setScale(1.1),r.setColor("#ffffff")}),r.on("pointerout",()=>{r.setScale(1),r.setColor("#00ff00")}),r.on("pointerdown",()=>{this.scene.restart()});const o=this.add.text(t/2,e*.78,"[ ËøîÂõû‰∏ªËèúÂçï ]",{fontSize:"32px",fontFamily:"Arial",fontStyle:"bold",color:"#8fd464",stroke:"#000000",strokeThickness:4}).setOrigin(.5).setScrollFactor(0).setDepth(2001).setInteractive({useHandCursor:!0});o.on("pointerover",()=>{o.setScale(1.1),o.setColor("#aaffaa")}),o.on("pointerout",()=>{o.setScale(1),o.setColor("#8fd464")}),o.on("pointerdown",()=>{this.cameras.main.fadeOut(300,0,0,0),this.cameras.main.once("camerafadeoutcomplete",()=>{this.scene.start("MainMenuScene")})}),this.input.keyboard?.once("keydown-SPACE",()=>{this.scene.restart()}),this.gameOverOverlay=this.add.container(0,0,[s,i,n,r]),this.gameOverOverlay.setDepth(2e3)}}const St={type:m.AUTO,parent:"app",backgroundColor:"#1a1a2e",scale:{mode:m.Scale.FIT,autoCenter:m.Scale.CENTER_BOTH,width:540,height:960},pixelArt:!0,antialias:!1,input:{touch:!0,activePointers:2},physics:{default:"arcade",arcade:{gravity:{x:0,y:0},debug:!1}},scene:[tt,Z],fps:{target:60}};new m.Game(St);
